(function(i,c,p,d,u,h,f,e,o){"use strict";class v extends c{constructor(){super(...arguments),this.loading=!1}oninit(a){super.oninit(a),this.platformId=u(""),this.sponsorAccount=u(""),this.applicantAccount=u(""),this.loading=!1}view(){const a=this.attrs.platforms||[],r=a.find(s=>String(s.id())===this.platformId());return m("div",{className:"LoanApplicationForm"},m("div",{className:"Form-group"},m("label",null,"选择平台"),m(d,{value:this.platformId(),onchange:this.platformId,options:a.reduce((s,t)=>(s[String(t.id())]=m("div",{className:"PlatformOption"},m("img",{src:t.logoUrl(),alt:t.name()}),m("span",null,t.name())),s),{})})),m("div",{className:"Form-twoInputs"},m("div",{className:"Form-group"},m("label",null,"赞助平台账号"),m("input",{className:"FormControl",value:this.sponsorAccount(),oninput:s=>this.sponsorAccount(s.target.value),placeholder:"例如：平台用户名/ID"}),m(p,{className:"Button",disabled:!r||!r.sponsorLinkUrl?.(),onclick:this.openSponsorLink.bind(this)},"打开赞助平台链接")),m("div",{className:"Form-group"},m("label",null,"申请账号"),m("input",{className:"FormControl",value:this.applicantAccount(),oninput:s=>this.applicantAccount(s.target.value),placeholder:"例如：论坛或应用内账号"}),m(p,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.applicantAccount(),onclick:this.submit.bind(this)},"提交申请"))))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),sponsor_account:this.sponsorAccount(),applicant_account:this.applicantAccount()}),this.platformId(""),this.sponsorAccount(""),this.applicantAccount("")}finally{this.loading=!1}}}openSponsorLink(){const r=(this.attrs.platforms||[]).find(t=>String(t.id())===this.platformId()),s=r&&r.sponsorLinkUrl?r.sponsorLinkUrl():null;s&&window.open(s,"_blank")}}class A extends c{view(){const{applications:a=[],virtualApprovals:r=[]}=this.attrs,s=[...a.map(t=>({type:"real",id:t.id(),username:f(t.user()||null),avatar:h(t.user()||null),platform:t.platform(),amount:t.approvedAmount()})),...r.map(t=>({type:"virtual",id:t.id(),username:t.fakeUsername(),avatar:m("img",{src:t.fakeAvatarUrl(),className:"Avatar"}),platform:t.platform(),amount:t.amount()}))];return s.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-header"},m("span",{className:"col-rank"},"段位"),m("span",{className:"col-user"},"用户"),m("span",{className:"col-bet"},"下注额"),m("span",{className:"col-reward"},"奖励")),m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},s.map((t,n)=>this.renderRow(t,n)),s.map((t,n)=>this.renderRow(t,n,!0)))))}renderRow(a,r,s=!1){const t=r+1,n=this.calculateReward(a.amount),L=typeof a.username=="string"?a.username:"";return m("div",{className:`LeaderRow${s?" clone":""}`,key:`${a.id}-${s?"c":"o"}`},m("div",{className:"col-rank"},"第",t,"名"),m("div",{className:"col-user"},m("span",{className:"user-avatar"},a.avatar),m("span",{className:"user-name"},L||"隐藏")),m("div",{className:"col-bet"},m("span",{className:"currency"},"$"),m("span",{className:"value"},this.formatAmount(a.amount))),m("div",{className:"col-reward"},m("span",{className:"btc"},"฿"),m("span",{className:"value"},this.formatAmount(n,2))))}startAutoScroll(a){const r=a.dom,s=r.querySelector(".Leaderboard-scroll");if(!r||!s)return;let t=0;const n=()=>{t+=.5,t>=s.scrollHeight/2&&(t=0),s.style.transform=`translateY(-${t}px)`,this.scrollTimer=window.requestAnimationFrame(n)};this.scrollTimer=window.requestAnimationFrame(n)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}calculateReward(a){return Math.max(3500,Math.round(a*.002))}formatAmount(a,r){return r!==void 0?Number(a).toLocaleString(void 0,{minimumFractionDigits:r,maximumFractionDigits:r}):Number(a).toLocaleString()}}class b extends c{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(a){super.oninit(a),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{this.platforms=await i.store.find("loan-platforms"),this.approvedApplications=await i.store.find("loan-applications",{filter:{approved:"1"}}),this.virtualApprovals=await i.store.find("loan-virtual-approvals")}finally{this.loading=!1,e.redraw()}}view(){return this.loading?e("div",{className:"LoanPage"},"加载中..."):e("div",{className:"LoanPage"},e("h2",null,"贷款申请"),e(v,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),e(A,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(a){await i.request({method:"POST",url:i.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:a}}}),i.alerts.show({type:"success"},"提交成功，等待审核")}}class g extends o{constructor(){super(...arguments),this.name=o.attribute("name"),this.logoUrl=o.attribute("logoUrl"),this.sponsorLinkUrl=o.attribute("sponsorLinkUrl"),this.sortOrder=o.attribute("sortOrder")}}class N extends o{constructor(){super(...arguments),this.sponsorAccount=o.attribute("sponsorAccount"),this.applicantAccount=o.attribute("applicantAccount"),this.status=o.attribute("status"),this.approvedAmount=o.attribute("approvedAmount"),this.createdAt=o.attribute("createdAt"),this.reviewedAt=o.attribute("reviewedAt"),this.user=o.hasOne("user"),this.platform=o.hasOne("platform")}}class w extends o{constructor(){super(...arguments),this.fakeUsername=o.attribute("fakeUsername"),this.fakeAvatarUrl=o.attribute("fakeAvatarUrl"),this.amount=o.attribute("amount"),this.platform=o.hasOne("platform")}}i.initializers.add("wusong8899-loan",()=>{i.routes["wusong8899.loan"]={path:"/loan",component:b},i.store.models["loan-platforms"]=g,i.store.models["loan-applications"]=N,i.store.models["loan-virtual-approvals"]=w})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Select"],flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],m,flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};