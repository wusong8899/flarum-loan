(function(u,f,A,t,h,g,v,c){"use strict";class y extends f{constructor(){super(...arguments),this.open=!1,this.handleDocClick=()=>{this.open&&(this.open=!1,t.redraw())}}oncreate(o){super.oncreate(o),document.addEventListener("click",this.handleDocClick)}onremove(o){super.onremove(o),document.removeEventListener("click",this.handleDocClick)}view(){const{platforms:o=[],value:s}=this.attrs,l=Array.isArray(o)?o.filter(r=>r&&typeof r.id=="function"&&r.id()!=null):[],n=l.find(r=>String(r.id())===s)||null;return t("div",{className:"LoanPlatformSelector"},t("div",{className:"LoanPlatformSelector-dropdown",onclick:r=>{r.stopPropagation(),this.toggle()}},t("div",{className:"LoanPlatformSelector-selected"},t("div",{className:"LoanPlatformSelector-info"},t("div",{className:"LoanPlatformSelector-icon"},n?t("img",{className:"PlatformIcon PlatformIcon--medium",src:n.logoUrl(),alt:n.name()}):t("span",{className:"PlatformIcon PlatformIcon--medium PlatformIcon--placeholder"})),t("div",{className:"LoanPlatformSelector-details"},t("div",{className:"LoanPlatformSelector-name"},n?n.name():"请选择平台"))),t("i",{className:`LoanPlatformSelector-dropdownIcon fas fa-chevron-${this.open?"up":"down"}`}))),this.open&&t("div",{className:"LoanPlatformSelector-dropdownMenu",onclick:r=>r.stopPropagation()},l.length===0?t("div",{className:"LoanPlatformSelector-dropdownItem LoanPlatformSelector-noData"},"暂无可选平台"):l.map((r,a)=>t("div",{key:String(r.id()??a),className:"LoanPlatformSelector-dropdownItem",onclick:()=>this.select(String(r.id()))},t("div",{className:"LoanPlatformSelector-icon"},t("img",{className:"PlatformIcon PlatformIcon--small",src:r.logoUrl(),alt:r.name()})),t("div",{className:"LoanPlatformSelector-name"},r.name())))))}toggle(){this.open=!this.open,t.redraw()}select(o){this.attrs.onchange(o),this.open=!1,t.redraw()}}class L extends f{constructor(){super(...arguments),this.loading=!1,this.listLoading=!1,this.myApplications=[]}oninit(o){console.log("[LoanApplicationForm] 组件初始化开始",o),super.oninit(o),this.platformId=h(""),this.sponsorAccount=h(""),this.applicantAccount=h(""),this.loading=!1,this.listLoading=!0,this.myApplications=[],console.log("[LoanApplicationForm] 属性设置完成，开始加载我的申请记录"),this.loadMyApplications()}view(){console.log("[LoanApplicationForm] 渲染view，状态:",{loading:this.loading,listLoading:this.listLoading,myApplicationsCount:this.myApplications.length,platformId:this.platformId(),sponsorAccount:this.sponsorAccount(),applicantAccount:this.applicantAccount()});const o=this.attrs.platforms||[];console.log("[LoanApplicationForm] 传入的平台数据:",o);const s=o.find(l=>String(l.id())===this.platformId());return console.log("[LoanApplicationForm] 选中的平台:",s),t("div",{className:"LoanApplicationForm"},t("div",{className:"Form-group"},t("label",null,"选择平台"),t("div",{style:{display:"flex",gap:"8px",alignItems:"center"}},t(y,{platforms:o,value:this.platformId(),onchange:this.platformId}),(!s||s.sponsorLinkUrl?.())&&t(A,{className:"Button",onclick:this.openSponsorLink.bind(this)},"打开赞助平台链接"))),t("div",{className:"Form-twoInputs"},t("div",{className:"Form-group"},t("label",null,"赞助平台账号"),t("input",{className:"FormControl",value:this.sponsorAccount(),oninput:l=>this.sponsorAccount(l.target.value),placeholder:"例如：平台用户名/ID"})),t("div",{className:"Form-group"},t("label",null,"申请账号"),t("input",{className:"FormControl",value:this.applicantAccount(),oninput:l=>this.applicantAccount(l.target.value),placeholder:"例如：论坛或应用内账号"}),t(A,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.applicantAccount(),onclick:this.submit.bind(this)},"提交申请"))),t("div",{className:"MyApplications"},t("h3",null,u.forum.attribute("loanLogoUrl")?t("img",{src:u.forum.attribute("loanLogoUrl"),alt:"logo",style:{height:"24px",verticalAlign:"middle",marginRight:"8px"}}):null,"您的申请订单"),this.listLoading?t("div",null,"加载中..."):t("div",{className:"OrderList"},t("div",{className:"OrderList-header"},t("span",null,"平台"),t("span",null,"赞助账号"),t("span",null,"申请账号"),t("span",null,"状态"),t("span",null,"批准额度")),t("div",{className:"OrderList-body"},Array.isArray(this.myApplications)&&this.myApplications.length>0?this.myApplications.filter(l=>!!l).map(l=>this.renderOrderRow(l)).filter(l=>l!==null):t("div",{className:"OrderList-empty"},"暂无记录")))))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),sponsor_account:this.sponsorAccount(),applicant_account:this.applicantAccount()}),this.platformId(""),this.sponsorAccount(""),this.applicantAccount(""),await this.loadMyApplications()}finally{this.loading=!1}}}openSponsorLink(){const s=(this.attrs.platforms||[]).find(n=>String(n.id())===this.platformId()),l=s&&s.sponsorLinkUrl?s.sponsorLinkUrl():null;l&&window.open(l,"_blank")}async loadMyApplications(){console.log("[LoanApplicationForm] 开始加载我的申请记录...");try{const o=await u.store.find("loan-applications",{include:"user,platform"});if(console.log("[LoanApplicationForm] API返回结果:",o),console.log("[LoanApplicationForm] 结果类型:",typeof o,"是否为数组:",Array.isArray(o)),Array.isArray(o)){console.log("[LoanApplicationForm] 原始数组长度:",o.length);const s=o.filter(a=>{const i=a!=null;return i||console.warn("[LoanApplicationForm] 发现null/undefined应用记录:",a),i}),l=u.session.user,n=l?l.id():null,r=n?s.filter(a=>{try{const i=a.user?a.user():null;return(i&&typeof i.id=="function"?i.id():null)===n}catch(i){return console.warn("[LoanApplicationForm] 读取应用用户失败:",i,a),!1}}):[];this.myApplications=r,console.log("[LoanApplicationForm] 过滤为当前用户后的数组长度:",r.length),s.forEach((a,i)=>{console.log(`[LoanApplicationForm] 应用记录 ${i}:`,{id:a.id?.(),platform:a.platform?.(),platformMethod:typeof a.platform,sponsorAccount:a.sponsorAccount?.(),applicantAccount:a.applicantAccount?.(),status:a.status?.(),approvedAmount:a.approvedAmount?.()})})}else console.warn("[LoanApplicationForm] API返回的不是数组，设置为空数组"),this.myApplications=[]}catch(o){console.error("[LoanApplicationForm] 加载申请记录失败:",o),this.myApplications=[]}finally{console.log("[LoanApplicationForm] 最终设置的应用记录数量:",this.myApplications.length),this.listLoading=!1,t.redraw()}}renderOrderRow(o){if(console.log("[LoanApplicationForm] 渲染订单行，应用模型:",o),!o)return console.warn("[LoanApplicationForm] 应用模型为null，跳过渲染"),null;console.log("[LoanApplicationForm] 应用模型详情:",{id:o.id?.(),hasId:typeof o.id,hasPlatform:typeof o.platform,hasSponsorAccount:typeof o.sponsorAccount,hasApplicantAccount:typeof o.applicantAccount,hasStatus:typeof o.status,hasApprovedAmount:typeof o.approvedAmount});const s=o.platform?o.platform():null;console.log("[LoanApplicationForm] 平台信息:",s),s&&console.log("[LoanApplicationForm] 平台详情:",{hasName:typeof s.name,hasLogoUrl:typeof s.logoUrl,hasCurrencyImageUrl:typeof s.currencyImageUrl,name:s.name?.(),logoUrl:s.logoUrl?.(),currencyImageUrl:s.currencyImageUrl?.()});const l=s&&s.name?s.name():"-",n=s&&s.logoUrl?s.logoUrl():"",r=s&&s.currencyImageUrl?s.currencyImageUrl():"",a=o.sponsorAccount?.()||"-",i=o.applicantAccount?.()||"-",e=this.statusText(o.status?o.status():void 0),p=o.approvedAmount?.();return console.log("[LoanApplicationForm] 渲染数据:",{platformName:l,platformLogo:n,currencyImg:r,sponsor:a,applicant:i,statusText:e,amount:p}),t("div",{className:"OrderList-row"},t("div",{className:"col-platform"},t("span",{className:"platform-logo-wrap"},n?t("img",{className:"platform-logo",src:n,alt:l}):t("span",{className:"platform-logo placeholder"})),t("span",{className:"platform-name"},l)),t("div",{className:"col-sponsor"},a),t("div",{className:"col-applicant"},i),t("div",{className:"col-status"},e||"-"),t("div",{className:"col-amount"},typeof p=="number"?t("span",{className:"amount"},r?t("img",{className:"currency",src:r,alt:"currency"}):t("span",{className:"currency-text"},"¥"),t("span",{className:"value"},this.formatAmount(p))):t("span",null,"-")))}statusText(o){switch(o){case"approved":return"已通过";case"rejected":return"已拒绝";case"pending":default:return"审核中"}}formatAmount(o){return Number(o).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}}class N extends f{view(){const{applications:o=[],virtualApprovals:s=[]}=this.attrs;console.log("[ApprovedApplicationsList] 渲染开始，输入数据:",{applicationsCount:o.length,virtualApprovalsCount:s.length,applications:o,virtualApprovals:s});const l=o.filter(a=>{const i=a!=null&&a.id()&&a.approvedAmount;return i||console.warn("[ApprovedApplicationsList] 过滤掉无效的真实申请:",{app:a,hasApp:a!=null,hasId:a?.id,hasApprovedAmount:a?.approvedAmount}),i}).map((a,i)=>{console.log(`[ApprovedApplicationsList] 处理真实申请 ${i}:`,a);const e=a.user?a.user():null,p=a.platform?a.platform():null;console.log(`[ApprovedApplicationsList] 真实申请 ${i} 详情:`,{id:a.id?.(),user:e,platform:p,username:e?v(e):null,avatar:e?g(e):null,approvedAmount:a.approvedAmount?.()});const w=e&&e.displayName&&typeof e.displayName=="function"?e.displayName():e&&e.username&&typeof e.username=="function"?e.username():"";return{type:"real",id:a.id(),displayName:w,avatar:g(e)||null,platformName:p&&p.name&&typeof p.name=="function"?p.name():"",platformLogoUrl:p&&p.logoUrl&&typeof p.logoUrl=="function"?p.logoUrl():"",currencyImageUrl:p&&p.currencyImageUrl&&typeof p.currencyImageUrl=="function"?p.currencyImageUrl():"",amount:a.approvedAmount()}}),n=s.filter(a=>{const i=a!=null&&a.id()&&a.amount;return i||console.warn("[ApprovedApplicationsList] 过滤掉无效的虚拟申请:",{va:a,hasVa:a!=null,hasId:a?.id,hasAmount:a?.amount}),i}).map((a,i)=>{console.log(`[ApprovedApplicationsList] 处理虚拟申请 ${i}:`,a);const e=a.platform?a.platform():null,p={type:"virtual",id:a.id(),displayName:a.fakeUsername?a.fakeUsername():"",avatar:a.fakeAvatarUrl?m("img",{src:a.fakeAvatarUrl(),className:"Avatar"}):null,platformName:e&&e.name&&typeof e.name=="function"?e.name():"",platformLogoUrl:e&&e.logoUrl&&typeof e.logoUrl=="function"?e.logoUrl():"",currencyImageUrl:e&&e.currencyImageUrl&&typeof e.currencyImageUrl=="function"?e.currencyImageUrl():"",amount:a.amount()};return console.log(`[ApprovedApplicationsList] 虚拟申请 ${i} 处理结果:`,p),p}),r=[...l,...n];return console.log("[ApprovedApplicationsList] 合并后的数据:",{realCount:l.length,virtualCount:n.length,totalCount:r.length,allApprovals:r}),r.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},m("table",{className:"Leaderboard-table"},m("thead",null,m("tr",null,m("th",{className:"col-avatar"},"用户"),m("th",{className:"col-nickname"},"昵称"),m("th",{className:"col-platform"},"贷款平台"),m("th",{className:"col-amount"},"获批额度"))),m("tbody",null,r.map((a,i)=>this.renderRow(a,i)),r.map((a,i)=>this.renderRow(a,i,!0)))))))}renderRow(o,s,l=!1){const n=typeof o.displayName=="string"?o.displayName:"",r=o.avatar?o.avatar:m("span",{className:"Avatar Avatar--placeholder"});return m("tr",{className:`LeaderRow${l?" clone":""}`,key:`${o.id}-${l?"c":"o"}`},m("td",{className:"col-avatar"},r),m("td",{className:"col-nickname"},n||"隐藏"),m("td",{className:"col-platform"},o.platformLogoUrl?m("span",{className:"platform-badge"},m("img",{src:o.platformLogoUrl,alt:""})):m("span",{className:"platform-badge platform-badge--placeholder"}),m("span",{className:"platform-name"},o.platformName||"-")),m("td",{className:"col-amount"},o.currencyImageUrl?m("img",{className:"coin",src:o.currencyImageUrl,alt:"coin"}):m("span",{className:"coin"},"¥"),m("span",{className:"value"},this.formatAmount(o.amount,2))))}startAutoScroll(o){const s=o.dom,l=s.querySelector(".Leaderboard-scroll");if(!s||!l)return;let n=0;const r=()=>{n+=.5,n>=l.scrollHeight/2&&(n=0),l.style.transform=`translateY(-${n}px)`,this.scrollTimer=window.requestAnimationFrame(r)};this.scrollTimer=window.requestAnimationFrame(r)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}formatAmount(o,s){return s!==void 0?Number(o).toLocaleString(void 0,{minimumFractionDigits:s,maximumFractionDigits:s}):Number(o).toLocaleString()}}class U extends f{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(o){console.log("[LoanApplicationPage] 页面组件初始化开始",o),super.oninit(o),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],console.log("[LoanApplicationPage] 属性设置完成，开始加载数据"),this.loadData()}async loadData(){console.log("[LoanApplicationPage] 开始加载页面数据..."),console.log("[LoanApplicationPage] 发起并行API请求...");const o=await Promise.allSettled([u.store.find("loan-platforms"),u.store.find("loan-applications",{filter:{approved:"1"},include:"user,platform"}),u.store.find("loan-virtual-approvals",{include:"platform"})]);if(o[0].status==="fulfilled"){const s=o[0].value;this.platforms=Array.isArray(s)?s.filter(l=>{const n=l!=null;return n||console.warn("[LoanApplicationPage] 发现null平台:",l),n}):[],console.log("[LoanApplicationPage] 平台加载成功，数量:",this.platforms.length),this.platforms.forEach((l,n)=>{console.log(`[LoanApplicationPage] 平台 ${n}:`,{id:l.id?.(),name:l.name?.(),logoUrl:l.logoUrl?.(),sponsorLinkUrl:l.sponsorLinkUrl?.(),currencyImageUrl:l.currencyImageUrl?.()})})}else console.error("[LoanApplicationPage] 加载平台失败:",o[0].reason),this.platforms=[];if(o[1].status==="fulfilled"){const s=o[1].value;this.approvedApplications=Array.isArray(s)?s.filter(l=>{const n=l!=null;return n||console.warn("[LoanApplicationPage] 发现null已批准申请:",l),n}):[],console.log("[LoanApplicationPage] 已批准申请加载成功，数量:",this.approvedApplications.length)}else console.error("[LoanApplicationPage] 加载已批准申请失败:",o[1].reason),this.approvedApplications=[];if(o[2].status==="fulfilled"){const s=o[2].value;this.virtualApprovals=Array.isArray(s)?s.filter(l=>{const n=l!=null;return n||console.warn("[LoanApplicationPage] 发现null虚拟批准:",l),n}):[],console.log("[LoanApplicationPage] 虚拟审批加载成功，数量:",this.virtualApprovals.length)}else console.error("[LoanApplicationPage] 加载虚拟审批失败:",o[2].reason),this.virtualApprovals=[];console.log("[LoanApplicationPage] 最终数据汇总:",{platformsCount:this.platforms.length,approvedAppsCount:this.approvedApplications.length,virtualApprovalsCount:this.virtualApprovals.length}),console.log("[LoanApplicationPage] 数据加载完成，设置loading为false"),this.loading=!1,t.redraw()}view(){return this.loading?t("div",{className:"LoanPage"},"加载中..."):t("div",{className:"LoanPage"},t("h2",null,"贷款申请"),t(L,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),t(N,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(o){await u.request({method:"POST",url:u.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:o}}}),u.alerts.show({type:"success"},"提交成功，等待审核")}}class I extends c{constructor(){super(...arguments),this.name=c.attribute("name"),this.logoUrl=c.attribute("logoUrl"),this.sponsorLinkUrl=c.attribute("sponsorLinkUrl"),this.currencyImageUrl=c.attribute("currencyImageUrl"),this.sortOrder=c.attribute("sortOrder")}}class b extends c{constructor(){super(...arguments),this.sponsorAccount=c.attribute("sponsorAccount"),this.applicantAccount=c.attribute("applicantAccount"),this.status=c.attribute("status"),this.approvedAmount=c.attribute("approvedAmount"),this.createdAt=c.attribute("createdAt"),this.reviewedAt=c.attribute("reviewedAt"),this.user=c.hasOne("user"),this.platform=c.hasOne("platform")}}class P extends c{constructor(){super(...arguments),this.fakeUsername=c.attribute("fakeUsername"),this.fakeAvatarUrl=c.attribute("fakeAvatarUrl"),this.amount=c.attribute("amount"),this.platform=c.hasOne("platform")}}u.initializers.add("wusong8899-loan",()=>{u.routes["wusong8899.loan"]={path:"/loan",component:U},u.store.models["loan-platforms"]=I,u.store.models["loan-applications"]=b,u.store.models["loan-virtual-approvals"]=P})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],m,flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};