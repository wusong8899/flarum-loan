(function(u,f,g,o,h,A,y,c){"use strict";class v extends f{constructor(){super(...arguments),this.open=!1,this.handleDocClick=()=>{this.open&&(this.open=!1,o.redraw())}}oncreate(t){super.oncreate(t),document.addEventListener("click",this.handleDocClick)}onremove(t){super.onremove(t),document.removeEventListener("click",this.handleDocClick)}view(){const{platforms:t=[],value:e}=this.attrs,a=Array.isArray(t)?t.filter(r=>r&&typeof r.id=="function"&&r.id()!=null):[],n=a.find(r=>String(r.id())===e)||null;return o("div",{className:"LoanPlatformSelector"},o("div",{className:"LoanPlatformSelector-dropdown",onclick:r=>{r.stopPropagation(),this.toggle()}},o("div",{className:"LoanPlatformSelector-selected"},o("div",{className:"LoanPlatformSelector-info"},o("div",{className:"LoanPlatformSelector-icon"},n?o("img",{className:"PlatformIcon PlatformIcon--medium",src:n.logoUrl(),alt:n.name()}):o("span",{className:"PlatformIcon PlatformIcon--medium PlatformIcon--placeholder"})),o("div",{className:"LoanPlatformSelector-details"},o("div",{className:"LoanPlatformSelector-name"},n?n.name():"请选择平台"))),o("i",{className:`LoanPlatformSelector-dropdownIcon fas fa-chevron-${this.open?"up":"down"}`}))),this.open&&o("div",{className:"LoanPlatformSelector-dropdownMenu",onclick:r=>r.stopPropagation()},a.length===0?o("div",{className:"LoanPlatformSelector-dropdownItem LoanPlatformSelector-noData"},"暂无可选平台"):a.map((r,s)=>o("div",{key:String(r.id()??s),className:"LoanPlatformSelector-dropdownItem",onclick:()=>this.select(String(r.id()))},o("div",{className:"LoanPlatformSelector-icon"},o("img",{className:"PlatformIcon PlatformIcon--small",src:r.logoUrl(),alt:r.name()})),o("div",{className:"LoanPlatformSelector-name"},r.name())))))}toggle(){this.open=!this.open,o.redraw()}select(t){this.attrs.onchange(t),this.open=!1,o.redraw()}}const L="M10.3259 3.91873C12.6748 5.25805 13.8493 5.92772 14.2435 6.802C14.5872 7.56458 14.5873 8.43542 14.2435 9.198C13.8493 10.0723 12.6748 10.7419 10.3259 12.0813C7.9769 13.4206 6.80242 14.0903 5.83867 13.9902C4.99805 13.903 4.2344 13.4675 3.73757 12.7922C3.16797 12.018 3.16797 10.6786 3.16797 8C3.16797 5.32135 3.16797 3.98203 3.73757 3.20778C4.2344 2.53245 4.99805 2.09703 5.83867 2.00978C6.80242 1.90974 7.9769 2.57941 10.3259 3.91873Z";class N extends f{constructor(){super(...arguments),this.loading=!1,this.listLoading=!1,this.myApplications=[]}oninit(t){console.log("[LoanApplicationForm] 组件初始化开始",t),super.oninit(t),this.platformId=h(""),this.sponsorAccount=h(""),this.repaymentDate=h(""),this.loading=!1,this.listLoading=!0,this.myApplications=[],console.log("[LoanApplicationForm] 属性设置完成，开始加载我的申请记录"),this.loadMyApplications()}view(){console.log("[LoanApplicationForm] 渲染view，状态:",{loading:this.loading,listLoading:this.listLoading,myApplicationsCount:this.myApplications.length,platformId:this.platformId(),sponsorAccount:this.sponsorAccount(),repaymentDate:this.repaymentDate()});const t=this.attrs.platforms||[];console.log("[LoanApplicationForm] 传入的平台数据:",t);const e=t.find(a=>String(a.id())===this.platformId());return console.log("[LoanApplicationForm] 选中的平台:",e),o("div",{className:"LoanApplicationForm"},o("div",{className:"Form-group"},o("label",null,"选择平台"),o("div",{style:{display:"flex",gap:"8px",alignItems:"center"}},o(v,{platforms:t,value:this.platformId(),onchange:this.platformId}),e?.sponsorLinkUrl?.()&&o("button",{className:"LoanRegisterButton",type:"button",onclick:this.openSponsorLink.bind(this)},o("span",{className:"register-icon","aria-hidden":"true"},o("svg",{width:"17",height:"17",viewBox:"0 0 17 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"},o("path",{d:L,stroke:"#FFFFFF"}))),"注册"))),o("div",{className:"Form-twoInputs"},o("div",{className:"Form-group"},o("label",null,"注册账号"),o("input",{className:"FormControl",value:this.sponsorAccount(),oninput:a=>this.sponsorAccount(a.target.value),placeholder:"请输入贷款账号ID"})),o("div",{className:"Form-group"},o("label",null,"还款日期"),o("input",{className:"FormControl",type:"date",value:this.repaymentDate(),oninput:a=>this.repaymentDate(a.target.value),placeholder:"请选择还款日期"}),o(g,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.repaymentDate(),onclick:this.submit.bind(this)},"提交申请"))),o("div",{className:"MyApplications"},o("h3",null,u.forum.attribute("loanLogoUrl")?o("img",{src:u.forum.attribute("loanLogoUrl"),alt:"logo",style:{height:"24px",verticalAlign:"middle",marginRight:"8px"}}):null,"您的申请订单"),this.listLoading?o("div",null,"加载中..."):o("div",{className:"OrderList"},o("div",{className:"OrderList-header"},o("span",null,"平台"),o("span",null,"赞助账号"),o("span",null,"还款日期"),o("span",null,"状态"),o("span",null,"批准额度")),o("div",{className:"OrderList-body"},Array.isArray(this.myApplications)&&this.myApplications.length>0?this.myApplications.filter(a=>!!a).map(a=>this.renderOrderRow(a)).filter(a=>a!==null):o("div",{className:"OrderList-empty"},"暂无记录")))))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),sponsor_account:this.sponsorAccount(),repayment_date:this.repaymentDate()}),this.platformId(""),this.sponsorAccount(""),this.repaymentDate(""),await this.loadMyApplications()}finally{this.loading=!1}}}openSponsorLink(){const e=(this.attrs.platforms||[]).find(n=>String(n.id())===this.platformId()),a=e&&e.sponsorLinkUrl?e.sponsorLinkUrl():null;a&&window.open(a,"_blank")}async loadMyApplications(){console.log("[LoanApplicationForm] 开始加载我的申请记录...");try{const t=await u.store.find("loan-applications",{include:"user,platform"});if(console.log("[LoanApplicationForm] API返回结果:",t),console.log("[LoanApplicationForm] 结果类型:",typeof t,"是否为数组:",Array.isArray(t)),Array.isArray(t)){console.log("[LoanApplicationForm] 原始数组长度:",t.length);const e=t.filter(s=>{const i=s!=null;return i||console.warn("[LoanApplicationForm] 发现null/undefined应用记录:",s),i}),a=u.session.user,n=a?a.id():null,r=n?e.filter(s=>{try{const i=s.user?s.user():null;return(i&&typeof i.id=="function"?i.id():null)===n}catch(i){return console.warn("[LoanApplicationForm] 读取应用用户失败:",i,s),!1}}):[];this.myApplications=r,console.log("[LoanApplicationForm] 过滤为当前用户后的数组长度:",r.length),e.forEach((s,i)=>{console.log(`[LoanApplicationForm] 应用记录 ${i}:`,{id:s.id?.(),platform:s.platform?.(),platformMethod:typeof s.platform,sponsorAccount:s.sponsorAccount?.(),repaymentDate:s.repaymentDate?.(),status:s.status?.(),approvedAmount:s.approvedAmount?.()})})}else console.warn("[LoanApplicationForm] API返回的不是数组，设置为空数组"),this.myApplications=[]}catch(t){console.error("[LoanApplicationForm] 加载申请记录失败:",t),this.myApplications=[]}finally{console.log("[LoanApplicationForm] 最终设置的应用记录数量:",this.myApplications.length),this.listLoading=!1,o.redraw()}}renderOrderRow(t){if(console.log("[LoanApplicationForm] 渲染订单行，应用模型:",t),!t)return console.warn("[LoanApplicationForm] 应用模型为null，跳过渲染"),null;console.log("[LoanApplicationForm] 应用模型详情:",{id:t.id?.(),hasId:typeof t.id,hasPlatform:typeof t.platform,hasSponsorAccount:typeof t.sponsorAccount,hasRepaymentDate:typeof t.repaymentDate,hasStatus:typeof t.status,hasApprovedAmount:typeof t.approvedAmount});const e=t.platform?t.platform():null;console.log("[LoanApplicationForm] 平台信息:",e),e&&console.log("[LoanApplicationForm] 平台详情:",{hasName:typeof e.name,hasLogoUrl:typeof e.logoUrl,hasCurrencyImageUrl:typeof e.currencyImageUrl,name:e.name?.(),logoUrl:e.logoUrl?.(),currencyImageUrl:e.currencyImageUrl?.()});const a=e&&e.name?e.name():"-",n=e&&e.logoUrl?e.logoUrl():"",r=e&&e.currencyImageUrl?e.currencyImageUrl():"",s=t.sponsorAccount?.()||"-",i=t.repaymentDate?.()||"",l=this.statusText(t.status?t.status():void 0),p=t.approvedAmount?.();return console.log("[LoanApplicationForm] 渲染数据:",{platformName:a,platformLogo:n,currencyImg:r,sponsor:s,repayment:i,statusText:l,amount:p}),o("div",{className:"OrderList-row"},o("div",{className:"col-platform"},o("span",{className:"platform-logo-wrap"},n?o("img",{className:"platform-logo",src:n,alt:a}):o("span",{className:"platform-logo placeholder"})),o("span",{className:"platform-name"},a)),o("div",{className:"col-sponsor"},s),o("div",{className:"col-repayment"},this.renderRepaymentCell(i)),o("div",{className:"col-status"},l||"-"),o("div",{className:"col-amount"},typeof p=="number"?o("span",{className:"amount"},r?o("img",{className:"currency",src:r,alt:"currency"}):o("span",{className:"currency-text"},"¥"),o("span",{className:"value"},this.formatAmount(p))):o("span",null,"-")))}statusText(t){switch(t){case"approved":return"已通过";case"rejected":return"已拒绝";case"pending":default:return"审核中"}}formatAmount(t){return Number(t).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}renderRepaymentCell(t){const e=parseInt(u.forum.attribute("loanRepaymentMaxMonths")||"6",10),a=this.isOverdueLong(t,e);return t?a?o("span",{className:"overdue"},"未还款"):o("span",null,t):o("span",null,"-")}isOverdueLong(t,e){if(!t)return!1;const a=new Date(t);if(isNaN(a.getTime()))return!1;const n=new Date;if(!e||e<=0)return n>a;const r=this.addMonths(a,e);return n>r}addMonths(t,e){const a=new Date(t.getTime()),n=a.getDate();return a.setMonth(a.getMonth()+e),a.getDate()<n&&a.setDate(0),a}}class w extends f{view(){const{applications:t=[],virtualApprovals:e=[]}=this.attrs;console.log("[ApprovedApplicationsList] 渲染开始，输入数据:",{applicationsCount:t.length,virtualApprovalsCount:e.length,applications:t,virtualApprovals:e});const a=t.filter(s=>{const i=s!=null&&s.id()&&s.approvedAmount;return i||console.warn("[ApprovedApplicationsList] 过滤掉无效的真实申请:",{app:s,hasApp:s!=null,hasId:s?.id,hasApprovedAmount:s?.approvedAmount}),i}).map((s,i)=>{console.log(`[ApprovedApplicationsList] 处理真实申请 ${i}:`,s);const l=s.user?s.user():null,p=s.platform?s.platform():null;console.log(`[ApprovedApplicationsList] 真实申请 ${i} 详情:`,{id:s.id?.(),user:l,platform:p,username:l?y(l):null,avatar:l?A(l):null,approvedAmount:s.approvedAmount?.()});const F=l&&l.displayName&&typeof l.displayName=="function"?l.displayName():l&&l.username&&typeof l.username=="function"?l.username():"";return{type:"real",id:s.id(),displayName:F,avatar:A(l)||null,platformName:p&&p.name&&typeof p.name=="function"?p.name():"",platformLogoUrl:p&&p.logoUrl&&typeof p.logoUrl=="function"?p.logoUrl():"",currencyImageUrl:p&&p.currencyImageUrl&&typeof p.currencyImageUrl=="function"?p.currencyImageUrl():"",amount:s.approvedAmount()}}),n=e.filter(s=>{const i=s!=null&&s.id()&&s.amount;return i||console.warn("[ApprovedApplicationsList] 过滤掉无效的虚拟申请:",{va:s,hasVa:s!=null,hasId:s?.id,hasAmount:s?.amount}),i}).map((s,i)=>{console.log(`[ApprovedApplicationsList] 处理虚拟申请 ${i}:`,s);const l=s.platform?s.platform():null,p={type:"virtual",id:s.id(),displayName:s.fakeUsername?s.fakeUsername():"",avatar:s.fakeAvatarUrl?m("img",{src:s.fakeAvatarUrl(),className:"Avatar"}):null,platformName:l&&l.name&&typeof l.name=="function"?l.name():"",platformLogoUrl:l&&l.logoUrl&&typeof l.logoUrl=="function"?l.logoUrl():"",currencyImageUrl:l&&l.currencyImageUrl&&typeof l.currencyImageUrl=="function"?l.currencyImageUrl():"",amount:s.amount()};return console.log(`[ApprovedApplicationsList] 虚拟申请 ${i} 处理结果:`,p),p}),r=[...a,...n];return console.log("[ApprovedApplicationsList] 合并后的数据:",{realCount:a.length,virtualCount:n.length,totalCount:r.length,allApprovals:r}),r.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-header"},m("span",{className:"col-user"},"用户"),m("span",{className:"col-platform"},"贷款平台"),m("span",{className:"col-amount"},"获批额度")),m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},r.map((s,i)=>this.renderRow(s,i)),r.map((s,i)=>this.renderRow(s,i,!0)))))}renderRow(t,e,a=!1){const n=typeof t.displayName=="string"?t.displayName:"",r=t.avatar?t.avatar:m("span",{className:"Avatar Avatar--placeholder"});return m("div",{className:`LeaderRow${a?" clone":""}`,key:`${t.id}-${a?"c":"o"}`},m("div",{className:"col-user"},r,m("span",{className:"nickname"},n||"隐藏")),m("div",{className:"col-platform"},t.platformLogoUrl?m("span",{className:"platform-badge"},m("img",{src:t.platformLogoUrl,alt:""})):m("span",{className:"platform-badge platform-badge--placeholder"}),m("span",{className:"platform-name"},t.platformName||"-")),m("div",{className:"col-amount"},t.currencyImageUrl?m("img",{className:"coin",src:t.currencyImageUrl,alt:"coin"}):m("span",{className:"coin"},"¥"),m("span",{className:"value"},this.formatAmount(t.amount,2))))}startAutoScroll(t){const e=t.dom,a=e.querySelector(".Leaderboard-scroll");if(!e||!a)return;let n=0;const r=()=>{n+=.5,n>=a.scrollHeight/2&&(n=0),a.style.transform=`translateY(-${n}px)`,this.scrollTimer=window.requestAnimationFrame(r)};this.scrollTimer=window.requestAnimationFrame(r)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}formatAmount(t,e){return e!==void 0?Number(t).toLocaleString(void 0,{minimumFractionDigits:e,maximumFractionDigits:e}):Number(t).toLocaleString()}}class U extends f{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(t){super.oninit(t),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){const t=await Promise.allSettled([u.store.find("loan-platforms"),u.store.find("loan-applications",{filter:{approved:"1"},include:"user,platform"}),u.store.find("loan-virtual-approvals",{include:"platform"})]);if(t[0].status==="fulfilled"){const e=t[0].value;this.platforms=Array.isArray(e)?e.filter(a=>{const n=a!=null;return n||console.warn("[LoanApplicationPage] 发现null平台:",a),n}):[],this.platforms.forEach((a,n)=>{console.log(`[LoanApplicationPage] 平台 ${n}:`,{id:a.id?.(),name:a.name?.(),logoUrl:a.logoUrl?.(),sponsorLinkUrl:a.sponsorLinkUrl?.(),currencyImageUrl:a.currencyImageUrl?.()})})}else console.error("[LoanApplicationPage] 加载平台失败:",t[0].reason),this.platforms=[];if(t[1].status==="fulfilled"){const e=t[1].value;this.approvedApplications=Array.isArray(e)?e.filter(a=>{const n=a!=null;return n||console.warn("[LoanApplicationPage] 发现null已批准申请:",a),n}):[],console.log("[LoanApplicationPage] 已批准申请加载成功，数量:",this.approvedApplications.length)}else console.error("[LoanApplicationPage] 加载已批准申请失败:",t[1].reason),this.approvedApplications=[];if(t[2].status==="fulfilled"){const e=t[2].value;this.virtualApprovals=Array.isArray(e)?e.filter(a=>{const n=a!=null;return n||console.warn("[LoanApplicationPage] 发现null虚拟批准:",a),n}):[]}else console.error("[LoanApplicationPage] 加载虚拟审批失败:",t[2].reason),this.virtualApprovals=[];this.loading=!1,o.redraw()}oncreate(){document.body.classList.add("loan-standalone")}onremove(){document.body.classList.remove("loan-standalone")}goBack(){if(window.history.length>1)window.history.back();else{const t=u.forum.attribute("baseUrl")||"/";window.location.href=t}}view(){return this.loading?o("div",{className:"LoanPage"},"加载中..."):o("div",{className:"LoanPage"},o("div",{className:"LoanBackButton"},o(g,{className:"Button Button--link",icon:"fas fa-arrow-left",onclick:this.goBack.bind(this)},"返回")),o("h2",null,"贷款申请"),o(N,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),o(w,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(t){await u.request({method:"POST",url:u.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:t}}}),u.alerts.show({type:"success"},"提交成功，等待审核")}}class b extends c{constructor(){super(...arguments),this.name=c.attribute("name"),this.logoUrl=c.attribute("logoUrl"),this.sponsorLinkUrl=c.attribute("sponsorLinkUrl"),this.currencyImageUrl=c.attribute("currencyImageUrl"),this.sortOrder=c.attribute("sortOrder")}}class I extends c{constructor(){super(...arguments),this.sponsorAccount=c.attribute("sponsorAccount"),this.repaymentDate=c.attribute("repaymentDate"),this.status=c.attribute("status"),this.approvedAmount=c.attribute("approvedAmount"),this.createdAt=c.attribute("createdAt"),this.reviewedAt=c.attribute("reviewedAt"),this.user=c.hasOne("user"),this.platform=c.hasOne("platform")}}class P extends c{constructor(){super(...arguments),this.fakeUsername=c.attribute("fakeUsername"),this.fakeAvatarUrl=c.attribute("fakeAvatarUrl"),this.amount=c.attribute("amount"),this.platform=c.hasOne("platform")}}u.initializers.add("wusong8899-loan",()=>{u.routes["wusong8899.loan"]={path:"/loan",component:U},u.store.models["loan-platforms"]=b,u.store.models["loan-applications"]=I,u.store.models["loan-virtual-approvals"]=P})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],m,flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};