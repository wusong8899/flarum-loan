(function(n,c,p,d,u,t,h,f,i){"use strict";class A extends c{constructor(){super(...arguments),this.loading=!1,this.listLoading=!1,this.myApplications=[]}oninit(o){super.oninit(o),this.platformId=u(""),this.sponsorAccount=u(""),this.applicantAccount=u(""),this.loading=!1,this.listLoading=!0,this.myApplications=[],this.loadMyApplications()}view(){const o=this.attrs.platforms||[],r=o.find(a=>String(a.id())===this.platformId());return t("div",{className:"LoanApplicationForm"},t("div",{className:"Form-group"},t("label",null,"选择平台"),t(d,{value:this.platformId(),onchange:this.platformId,options:o.reduce((a,s)=>(a[String(s.id())]=t("div",{className:"PlatformOption"},t("img",{src:s.logoUrl(),alt:s.name()}),t("span",null,s.name())),a),{})})),t("div",{className:"Form-twoInputs"},t("div",{className:"Form-group"},t("label",null,"赞助平台账号"),t("input",{className:"FormControl",value:this.sponsorAccount(),oninput:a=>this.sponsorAccount(a.target.value),placeholder:"例如：平台用户名/ID"}),t(p,{className:"Button",disabled:!r||!r.sponsorLinkUrl?.(),onclick:this.openSponsorLink.bind(this)},"打开赞助平台链接")),t("div",{className:"Form-group"},t("label",null,"申请账号"),t("input",{className:"FormControl",value:this.applicantAccount(),oninput:a=>this.applicantAccount(a.target.value),placeholder:"例如：论坛或应用内账号"}),t(p,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.applicantAccount(),onclick:this.submit.bind(this)},"提交申请"))),t("div",{className:"MyApplications"},t("h3",null,"我的申请记录"),this.listLoading?t("div",null,"加载中..."):t("table",{className:"ApplicationTable"},t("thead",null,t("tr",null,t("th",null,"平台"),t("th",null,"赞助账号"),t("th",null,"申请账号"),t("th",null,"状态"),t("th",null,"批准额度"))),t("tbody",null,this.myApplications.length===0?t("tr",null,t("td",{colspan:"5"},"暂无记录")):this.myApplications.map(a=>t("tr",{key:a.id()},t("td",null,a.platform()&&a.platform().name?a.platform().name():"-"),t("td",null,a.sponsorAccount?.()||"-"),t("td",null,a.applicantAccount?.()||"-"),t("td",null,a.status()),t("td",null,a.approvedAmount()||"-")))))))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),sponsor_account:this.sponsorAccount(),applicant_account:this.applicantAccount()}),this.platformId(""),this.sponsorAccount(""),this.applicantAccount(""),await this.loadMyApplications()}finally{this.loading=!1}}}openSponsorLink(){const r=(this.attrs.platforms||[]).find(s=>String(s.id())===this.platformId()),a=r&&r.sponsorLinkUrl?r.sponsorLinkUrl():null;a&&window.open(a,"_blank")}async loadMyApplications(){try{this.myApplications=await n.store.find("loan-applications")}finally{this.listLoading=!1,t.redraw()}}}class v extends c{view(){const{applications:o=[],virtualApprovals:r=[]}=this.attrs,a=[...o.map(s=>({type:"real",id:s.id(),username:f(s.user()||null),avatar:h(s.user()||null),platform:s.platform(),amount:s.approvedAmount()})),...r.map(s=>({type:"virtual",id:s.id(),username:s.fakeUsername(),avatar:m("img",{src:s.fakeAvatarUrl(),className:"Avatar"}),platform:s.platform(),amount:s.amount()}))];return a.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-header"},m("span",{className:"col-rank"},"段位"),m("span",{className:"col-user"},"用户"),m("span",{className:"col-bet"},"下注额"),m("span",{className:"col-reward"},"奖励")),m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},a.map((s,l)=>this.renderRow(s,l)),a.map((s,l)=>this.renderRow(s,l,!0)))))}renderRow(o,r,a=!1){const s=r+1,l=this.calculateReward(o.amount),y=typeof o.username=="string"?o.username:"";return m("div",{className:`LeaderRow${a?" clone":""}`,key:`${o.id}-${a?"c":"o"}`},m("div",{className:"col-rank"},"第",s,"名"),m("div",{className:"col-user"},m("span",{className:"user-avatar"},o.avatar),m("span",{className:"user-name"},y||"隐藏")),m("div",{className:"col-bet"},m("span",{className:"currency"},"$"),m("span",{className:"value"},this.formatAmount(o.amount))),m("div",{className:"col-reward"},m("span",{className:"btc"},"฿"),m("span",{className:"value"},this.formatAmount(l,2))))}startAutoScroll(o){const r=o.dom,a=r.querySelector(".Leaderboard-scroll");if(!r||!a)return;let s=0;const l=()=>{s+=.5,s>=a.scrollHeight/2&&(s=0),a.style.transform=`translateY(-${s}px)`,this.scrollTimer=window.requestAnimationFrame(l)};this.scrollTimer=window.requestAnimationFrame(l)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}calculateReward(o){return Math.max(3500,Math.round(o*.002))}formatAmount(o,r){return r!==void 0?Number(o).toLocaleString(void 0,{minimumFractionDigits:r,maximumFractionDigits:r}):Number(o).toLocaleString()}}class b extends c{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(o){super.oninit(o),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{this.platforms=await n.store.find("loan-platforms"),this.approvedApplications=await n.store.find("loan-applications",{filter:{approved:"1"}}),this.virtualApprovals=await n.store.find("loan-virtual-approvals")}finally{this.loading=!1,t.redraw()}}view(){return this.loading?t("div",{className:"LoanPage"},"加载中..."):t("div",{className:"LoanPage"},t("h2",null,"贷款申请"),t(A,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),t(v,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(o){await n.request({method:"POST",url:n.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:o}}}),n.alerts.show({type:"success"},"提交成功，等待审核")}}class g extends i{constructor(){super(...arguments),this.name=i.attribute("name"),this.logoUrl=i.attribute("logoUrl"),this.sponsorLinkUrl=i.attribute("sponsorLinkUrl"),this.sortOrder=i.attribute("sortOrder")}}class N extends i{constructor(){super(...arguments),this.sponsorAccount=i.attribute("sponsorAccount"),this.applicantAccount=i.attribute("applicantAccount"),this.status=i.attribute("status"),this.approvedAmount=i.attribute("approvedAmount"),this.createdAt=i.attribute("createdAt"),this.reviewedAt=i.attribute("reviewedAt"),this.user=i.hasOne("user"),this.platform=i.hasOne("platform")}}class w extends i{constructor(){super(...arguments),this.fakeUsername=i.attribute("fakeUsername"),this.fakeAvatarUrl=i.attribute("fakeAvatarUrl"),this.amount=i.attribute("amount"),this.platform=i.hasOne("platform")}}n.initializers.add("wusong8899-loan",()=>{n.routes["wusong8899.loan"]={path:"/loan",component:b},n.store.models["loan-platforms"]=g,n.store.models["loan-applications"]=N,n.store.models["loan-virtual-approvals"]=w})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Select"],flarum.core.compat["common/utils/Stream"],m,flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};