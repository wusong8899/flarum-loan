(function(o,c,p,d,u,h,f,n,s){"use strict";class v extends c{constructor(){super(...arguments),this.loading=!1}oninit(a){super.oninit(a),this.platformId=u(""),this.message=u(""),this.loading=!1}view(){const a=this.attrs.platforms||[];return m("div",{className:"LoanApplicationForm"},m("div",{className:"Form-group"},m("label",null,"选择平台"),m(d,{value:this.platformId(),onchange:this.platformId,options:a.reduce((r,e)=>(r[String(e.id())]=m("div",{className:"PlatformOption"},m("img",{src:e.logoUrl(),alt:e.name()}),m("span",null,e.name())),r),{})})),m("div",{className:"Form-group"},m("label",null,"留言"),m("textarea",{className:"FormControl",value:this.message(),oninput:r=>this.message(r.target.value),placeholder:"请输入您的留言...",rows:"4"})),m(p,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.message(),onclick:this.submit.bind(this)},"提交申请"))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),message:this.message()}),this.platformId(""),this.message("")}finally{this.loading=!1}}}}class g extends c{view(){const{applications:a=[],virtualApprovals:r=[]}=this.attrs,e=[...a.map(t=>({type:"real",id:t.id(),username:f(t.user()||null),avatar:h(t.user()||null),platform:t.platform(),amount:t.approvedAmount()})),...r.map(t=>({type:"virtual",id:t.id(),username:t.fakeUsername(),avatar:m("img",{src:t.fakeAvatarUrl(),className:"Avatar"}),platform:t.platform(),amount:t.amount()}))];return e.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-header"},m("span",{className:"col-rank"},"段位"),m("span",{className:"col-user"},"用户"),m("span",{className:"col-bet"},"下注额"),m("span",{className:"col-reward"},"奖励")),m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},e.map((t,i)=>this.renderRow(t,i)),e.map((t,i)=>this.renderRow(t,i,!0)))))}renderRow(a,r,e=!1){const t=r+1,i=this.calculateReward(a.amount),y=typeof a.username=="string"?a.username:"";return m("div",{className:`LeaderRow${e?" clone":""}`,key:`${a.id}-${e?"c":"o"}`},m("div",{className:"col-rank"},"第",t,"名"),m("div",{className:"col-user"},m("span",{className:"user-avatar"},a.avatar),m("span",{className:"user-name"},y||"隐藏")),m("div",{className:"col-bet"},m("span",{className:"currency"},"$"),m("span",{className:"value"},this.formatAmount(a.amount))),m("div",{className:"col-reward"},m("span",{className:"btc"},"฿"),m("span",{className:"value"},this.formatAmount(i,2))))}startAutoScroll(a){const r=a.dom,e=r.querySelector(".Leaderboard-scroll");if(!r||!e)return;let t=0;const i=()=>{t+=.5,t>=e.scrollHeight/2&&(t=0),e.style.transform=`translateY(-${t}px)`,this.scrollTimer=window.requestAnimationFrame(i)};this.scrollTimer=window.requestAnimationFrame(i)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}calculateReward(a){return Math.max(3500,Math.round(a*.002))}formatAmount(a,r){return r!==void 0?Number(a).toLocaleString(void 0,{minimumFractionDigits:r,maximumFractionDigits:r}):Number(a).toLocaleString()}}class A extends c{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(a){super.oninit(a),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{this.platforms=await o.store.find("loan-platforms"),this.approvedApplications=await o.store.find("loan-applications",{filter:{approved:"1"}}),this.virtualApprovals=await o.store.find("loan-virtual-approvals")}finally{this.loading=!1,n.redraw()}}view(){return this.loading?n("div",{className:"LoanPage"},"加载中..."):n("div",{className:"LoanPage"},n("h2",null,"贷款申请"),n(v,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),n(g,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(a){await o.request({method:"POST",url:o.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:a}}}),o.alerts.show({type:"success"},"提交成功，等待审核")}}class b extends s{constructor(){super(...arguments),this.name=s.attribute("name"),this.logoUrl=s.attribute("logoUrl"),this.sortOrder=s.attribute("sortOrder")}}class N extends s{constructor(){super(...arguments),this.message=s.attribute("message"),this.status=s.attribute("status"),this.approvedAmount=s.attribute("approvedAmount"),this.createdAt=s.attribute("createdAt"),this.reviewedAt=s.attribute("reviewedAt"),this.user=s.hasOne("user"),this.platform=s.hasOne("platform")}}class w extends s{constructor(){super(...arguments),this.fakeUsername=s.attribute("fakeUsername"),this.fakeAvatarUrl=s.attribute("fakeAvatarUrl"),this.amount=s.attribute("amount"),this.platform=s.hasOne("platform")}}o.initializers.add("wusong8899-loan",()=>{o.routes["wusong8899.loan"]={path:"/loan",component:A},o.store.models["loan-platforms"]=b,o.store.models["loan-applications"]=N,o.store.models["loan-virtual-approvals"]=w})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Select"],flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],m,flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};