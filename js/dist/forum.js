(function(e,u,p,h,c,d,v,n,s){"use strict";class f extends u{constructor(){super(...arguments),this.loading=!1}oninit(t){super.oninit(t),this.platformId=c(""),this.message=c(""),this.sponsorAccount=c(""),this.applicantAccount=c(""),this.loading=!1}view(){const t=this.attrs.platforms||[];return m("div",{className:"LoanApplicationForm"},m("div",{className:"Form-group"},m("label",null,"选择平台"),m(h,{value:this.platformId(),onchange:this.platformId,options:t.reduce((r,o)=>(r[String(o.id())]=m("div",{className:"PlatformOption"},m("img",{src:o.logoUrl(),alt:o.name()}),m("span",null,o.name())),r),{})})),m("div",{className:"Form-twoInputs"},m("div",{className:"Form-group"},m("label",null,"赞助平台账号"),m("input",{className:"FormControl",value:this.sponsorAccount(),oninput:r=>this.sponsorAccount(r.target.value),placeholder:"例如：平台用户名/ID"})),m("div",{className:"Form-group"},m("label",null,"申请账号"),m("input",{className:"FormControl",value:this.applicantAccount(),oninput:r=>this.applicantAccount(r.target.value),placeholder:"例如：论坛或应用内账号"}))),m("div",{className:"Form-group"},m("label",null,"留言（可选）"),m("textarea",{className:"FormControl",value:this.message(),oninput:r=>this.message(r.target.value),placeholder:"请输入备注信息...",rows:"3"})),m(p,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.applicantAccount(),onclick:this.submit.bind(this)},"提交申请"))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),message:this.message(),sponsor_account:this.sponsorAccount(),applicant_account:this.applicantAccount()}),this.platformId(""),this.message(""),this.sponsorAccount(""),this.applicantAccount("")}finally{this.loading=!1}}}}class A extends u{view(){const{applications:t=[],virtualApprovals:r=[]}=this.attrs,o=[...t.map(a=>({type:"real",id:a.id(),username:v(a.user()||null),avatar:d(a.user()||null),platform:a.platform(),amount:a.approvedAmount()})),...r.map(a=>({type:"virtual",id:a.id(),username:a.fakeUsername(),avatar:m("img",{src:a.fakeAvatarUrl(),className:"Avatar"}),platform:a.platform(),amount:a.amount()}))];return o.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-header"},m("span",{className:"col-rank"},"段位"),m("span",{className:"col-user"},"用户"),m("span",{className:"col-bet"},"下注额"),m("span",{className:"col-reward"},"奖励")),m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},o.map((a,i)=>this.renderRow(a,i)),o.map((a,i)=>this.renderRow(a,i,!0)))))}renderRow(t,r,o=!1){const a=r+1,i=this.calculateReward(t.amount),L=typeof t.username=="string"?t.username:"";return m("div",{className:`LeaderRow${o?" clone":""}`,key:`${t.id}-${o?"c":"o"}`},m("div",{className:"col-rank"},"第",a,"名"),m("div",{className:"col-user"},m("span",{className:"user-avatar"},t.avatar),m("span",{className:"user-name"},L||"隐藏")),m("div",{className:"col-bet"},m("span",{className:"currency"},"$"),m("span",{className:"value"},this.formatAmount(t.amount))),m("div",{className:"col-reward"},m("span",{className:"btc"},"฿"),m("span",{className:"value"},this.formatAmount(i,2))))}startAutoScroll(t){const r=t.dom,o=r.querySelector(".Leaderboard-scroll");if(!r||!o)return;let a=0;const i=()=>{a+=.5,a>=o.scrollHeight/2&&(a=0),o.style.transform=`translateY(-${a}px)`,this.scrollTimer=window.requestAnimationFrame(i)};this.scrollTimer=window.requestAnimationFrame(i)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}calculateReward(t){return Math.max(3500,Math.round(t*.002))}formatAmount(t,r){return r!==void 0?Number(t).toLocaleString(void 0,{minimumFractionDigits:r,maximumFractionDigits:r}):Number(t).toLocaleString()}}class g extends u{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(t){super.oninit(t),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{this.platforms=await e.store.find("loan-platforms"),this.approvedApplications=await e.store.find("loan-applications",{filter:{approved:"1"}}),this.virtualApprovals=await e.store.find("loan-virtual-approvals")}finally{this.loading=!1,n.redraw()}}view(){return this.loading?n("div",{className:"LoanPage"},"加载中..."):n("div",{className:"LoanPage"},n("h2",null,"贷款申请"),n(f,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),n(A,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(t){await e.request({method:"POST",url:e.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:t}}}),e.alerts.show({type:"success"},"提交成功，等待审核")}}class b extends s{constructor(){super(...arguments),this.name=s.attribute("name"),this.logoUrl=s.attribute("logoUrl"),this.sponsorLinkUrl=s.attribute("sponsorLinkUrl"),this.sortOrder=s.attribute("sortOrder")}}class N extends s{constructor(){super(...arguments),this.message=s.attribute("message"),this.sponsorAccount=s.attribute("sponsorAccount"),this.applicantAccount=s.attribute("applicantAccount"),this.status=s.attribute("status"),this.approvedAmount=s.attribute("approvedAmount"),this.createdAt=s.attribute("createdAt"),this.reviewedAt=s.attribute("reviewedAt"),this.user=s.hasOne("user"),this.platform=s.hasOne("platform")}}class w extends s{constructor(){super(...arguments),this.fakeUsername=s.attribute("fakeUsername"),this.fakeAvatarUrl=s.attribute("fakeAvatarUrl"),this.amount=s.attribute("amount"),this.platform=s.hasOne("platform")}}e.initializers.add("wusong8899-loan",()=>{e.routes["wusong8899.loan"]={path:"/loan",component:g},e.store.models["loan-platforms"]=b,e.store.models["loan-applications"]=N,e.store.models["loan-virtual-approvals"]=w})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Select"],flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],m,flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};