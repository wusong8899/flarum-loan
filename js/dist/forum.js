(function(t,r,p,c,e,u,d,i){"use strict";class h extends r{constructor(){super(...arguments),this.loading=!1}oninit(s){super.oninit(s),this.platformId=e(""),this.message=e(""),this.loading=!1}view(){const s=this.attrs.platforms||[];return m("div",{className:"LoanApplicationForm"},m("div",{className:"Form-group"},m("label",null,"选择平台"),m(c,{value:this.platformId(),onchange:this.platformId,options:s.reduce((l,o)=>(l[String(o.id())]=m("div",{className:"PlatformOption"},m("img",{src:o.logoUrl(),alt:o.name()}),m("span",null,o.name())),l),{})})),m("div",{className:"Form-group"},m("label",null,"留言"),m("textarea",{className:"FormControl",value:this.message(),oninput:l=>this.message(l.target.value),placeholder:"请输入您的留言...",rows:"4"})),m(p,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.message(),onclick:this.submit.bind(this)},"提交申请"))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),message:this.message()}),this.platformId(""),this.message("")}finally{this.loading=!1}}}}class f extends r{view(){const{applications:s=[],virtualApprovals:l=[]}=this.attrs,o=[...s.map(a=>({type:"real",id:a.id(),username:d(a.user()||null),avatar:u(a.user()||null),platform:a.platform(),amount:a.approvedAmount()})),...l.map(a=>({type:"virtual",id:a.id(),username:a.fakeUsername(),avatar:m("img",{src:a.fakeAvatarUrl(),className:"Avatar"}),platform:a.platform(),amount:a.amount()}))];return o.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList"},m("h3",null,"申请通过列表"),m("div",{className:"ApprovalCards"},o.map(a=>m("div",{className:"ApprovalCard",key:a.id},m("div",{className:"ApprovalCard-user"},a.avatar,m("span",{className:"username"},a.username)),m("div",{className:"ApprovalCard-platform"},m("img",{src:a.platform.logoUrl?.(),alt:a.platform.name?.(),className:"platform-logo"}),m("span",{className:"platform-name"},a.platform.name?.())),m("div",{className:"ApprovalCard-amount"},m("span",{className:"amount-label"},"获批额度"),m("span",{className:"amount-value"},"¥",a.amount))))))}}class v extends r{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(s){super.oninit(s),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{this.platforms=await t.store.find("loan-platforms"),this.approvedApplications=await t.store.find("loan-applications",{filter:{approved:"1"}}),this.virtualApprovals=await t.store.find("loan-virtual-approvals")}finally{this.loading=!1,i.redraw()}}view(){return this.loading?i("div",{className:"LoanPage"},"加载中..."):i("div",{className:"LoanPage"},i("h2",null,"贷款申请"),i(h,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),i(f,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(s){await t.request({method:"POST",url:t.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:s}}}),t.alerts.show({type:"success"},"提交成功，等待审核")}}t.initializers.add("wusong8899-loan",()=>{t.routes["wusong8899.loan"]={path:"/loan",component:v}})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Select"],flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],m);
//# sourceMappingURL=forum.js.map

module.exports={};