(function(n,u,h,a,p,v,A,l){"use strict";class g extends u{constructor(){super(...arguments),this.open=!1,this.handleDocClick=()=>{this.open&&(this.open=!1,a.redraw())}}oncreate(t){super.oncreate(t),document.addEventListener("click",this.handleDocClick)}onremove(t){super.onremove(t),document.removeEventListener("click",this.handleDocClick)}view(){const{platforms:t=[],value:o}=this.attrs,r=Array.isArray(t)?t.filter(e=>e&&typeof e.id=="function"&&e.id()!=null):[],s=r.find(e=>String(e.id())===o)||null;return a("div",{className:"LoanPlatformSelector"},a("div",{className:"LoanPlatformSelector-dropdown",onclick:e=>{e.stopPropagation(),this.toggle()}},a("div",{className:"LoanPlatformSelector-selected"},a("div",{className:"LoanPlatformSelector-info"},a("div",{className:"LoanPlatformSelector-icon"},s?a("img",{className:"PlatformIcon PlatformIcon--medium",src:s.logoUrl(),alt:s.name()}):a("span",{className:"PlatformIcon PlatformIcon--medium PlatformIcon--placeholder"})),a("div",{className:"LoanPlatformSelector-details"},a("div",{className:"LoanPlatformSelector-name"},s?s.name():"请选择平台"))),a("i",{className:`LoanPlatformSelector-dropdownIcon fas fa-chevron-${this.open?"up":"down"}`}))),this.open&&a("div",{className:"LoanPlatformSelector-dropdownMenu",onclick:e=>e.stopPropagation()},r.length===0?a("div",{className:"LoanPlatformSelector-dropdownItem LoanPlatformSelector-noData"},"暂无可选平台"):r.map((e,i)=>a("div",{key:String(e.id()??i),className:"LoanPlatformSelector-dropdownItem",onclick:()=>this.select(String(e.id()))},a("div",{className:"LoanPlatformSelector-icon"},a("img",{className:"PlatformIcon PlatformIcon--small",src:e.logoUrl(),alt:e.name()})),a("div",{className:"LoanPlatformSelector-name"},e.name())))))}toggle(){this.open=!this.open,a.redraw()}select(t){this.attrs.onchange(t),this.open=!1,a.redraw()}}class N extends u{constructor(){super(...arguments),this.loading=!1,this.listLoading=!1,this.myApplications=[]}oninit(t){super.oninit(t),this.platformId=p(""),this.sponsorAccount=p(""),this.applicantAccount=p(""),this.loading=!1,this.listLoading=!0,this.myApplications=[],this.loadMyApplications()}view(){const t=this.attrs.platforms||[],o=t.find(r=>String(r.id())===this.platformId());return a("div",{className:"LoanApplicationForm"},a("div",{className:"Form-group"},a("label",null,"选择平台"),a(g,{platforms:t,value:this.platformId(),onchange:this.platformId})),a("div",{className:"Form-twoInputs"},a("div",{className:"Form-group"},a("label",null,"赞助平台账号"),a("input",{className:"FormControl",value:this.sponsorAccount(),oninput:r=>this.sponsorAccount(r.target.value),placeholder:"例如：平台用户名/ID"}),a(h,{className:"Button",disabled:!o||!o.sponsorLinkUrl?.(),onclick:this.openSponsorLink.bind(this)},"打开赞助平台链接")),a("div",{className:"Form-group"},a("label",null,"申请账号"),a("input",{className:"FormControl",value:this.applicantAccount(),oninput:r=>this.applicantAccount(r.target.value),placeholder:"例如：论坛或应用内账号"}),a(h,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.applicantAccount(),onclick:this.submit.bind(this)},"提交申请"))),a("div",{className:"MyApplications"},a("h3",null,"您的申请订单"),this.listLoading?a("div",null,"加载中..."):a("div",{className:"OrderList"},a("div",{className:"OrderList-header"},a("span",null,"平台"),a("span",null,"赞助账号"),a("span",null,"申请账号"),a("span",null,"状态"),a("span",null,"批准额度")),a("div",{className:"OrderList-body"},Array.isArray(this.myApplications)&&this.myApplications.length>0?this.myApplications.filter(r=>!!r).map(r=>this.renderOrderRow(r)).filter(r=>r!==null):a("div",{className:"OrderList-empty"},"暂无记录")))))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),sponsor_account:this.sponsorAccount(),applicant_account:this.applicantAccount()}),this.platformId(""),this.sponsorAccount(""),this.applicantAccount(""),await this.loadMyApplications()}finally{this.loading=!1}}}openSponsorLink(){const o=(this.attrs.platforms||[]).find(s=>String(s.id())===this.platformId()),r=o&&o.sponsorLinkUrl?o.sponsorLinkUrl():null;r&&window.open(r,"_blank")}async loadMyApplications(){try{const t=await n.store.find("loan-applications");this.myApplications=Array.isArray(t)?t.filter(o=>o!=null):[]}catch(t){console.error("Failed to load loan applications:",t),this.myApplications=[]}finally{this.listLoading=!1,a.redraw()}}renderOrderRow(t){if(!t)return null;const o=t.platform?t.platform():null,r=o&&o.name?o.name():"-",s=o&&o.logoUrl?o.logoUrl():"",e=o&&o.currencyImageUrl?o.currencyImageUrl():"",i=t.sponsorAccount?.()||"-",d=t.applicantAccount?.()||"-",k=this.statusText(t.status?t.status():void 0),f=t.approvedAmount?.();return a("div",{className:"OrderList-row"},a("div",{className:"col-platform"},a("span",{className:"platform-logo-wrap"},s?a("img",{className:"platform-logo",src:s,alt:r}):a("span",{className:"platform-logo placeholder"})),a("span",{className:"platform-name"},r)),a("div",{className:"col-sponsor"},i),a("div",{className:"col-applicant"},d),a("div",{className:"col-status"},k||"-"),a("div",{className:"col-amount"},typeof f=="number"?a("span",{className:"amount"},e?a("img",{className:"currency",src:e,alt:"currency"}):a("span",{className:"currency-text"},"¥"),a("span",{className:"value"},this.formatAmount(f))):a("span",null,"-")))}statusText(t){switch(t){case"approved":return"已通过";case"rejected":return"已拒绝";case"pending":default:return"审核中"}}formatAmount(t){return Number(t).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}}class y extends u{view(){const{applications:t=[],virtualApprovals:o=[]}=this.attrs,r=[...t.filter(s=>s!=null&&s.id&&s.approvedAmount).map(s=>{const e=s.user?s.user():null,i=s.platform?s.platform():null;return{type:"real",id:s.id(),username:A(e)||"",avatar:v(e)||null,platform:i,amount:s.approvedAmount()}}),...o.filter(s=>s!=null&&s.id&&s.amount).map(s=>({type:"virtual",id:s.id(),username:s.fakeUsername?s.fakeUsername():"",avatar:s.fakeAvatarUrl?m("img",{src:s.fakeAvatarUrl(),className:"Avatar"}):null,platform:s.platform?s.platform():null,amount:s.amount()}))];return r.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-header"},m("span",{className:"col-rank"},"段位"),m("span",{className:"col-user"},"用户"),m("span",{className:"col-bet"},"下注额"),m("span",{className:"col-reward"},"奖励")),m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},r.map((s,e)=>this.renderRow(s,e)),r.map((s,e)=>this.renderRow(s,e,!0)))))}renderRow(t,o,r=!1){const s=o+1,e=this.calculateReward(t.amount),i=typeof t.username=="string"?t.username:"",d=t.avatar?t.avatar:m("span",{className:"Avatar Avatar--placeholder"});return m("div",{className:`LeaderRow${r?" clone":""}`,key:`${t.id}-${r?"c":"o"}`},m("div",{className:"col-rank"},"第",s,"名"),m("div",{className:"col-user"},m("span",{className:"user-avatar"},d),m("span",{className:"user-name"},i||"隐藏")),m("div",{className:"col-bet"},m("span",{className:"currency"},"$"),m("span",{className:"value"},this.formatAmount(t.amount))),m("div",{className:"col-reward"},m("span",{className:"btc"},"฿"),m("span",{className:"value"},this.formatAmount(e,2))))}startAutoScroll(t){const o=t.dom,r=o.querySelector(".Leaderboard-scroll");if(!o||!r)return;let s=0;const e=()=>{s+=.5,s>=r.scrollHeight/2&&(s=0),r.style.transform=`translateY(-${s}px)`,this.scrollTimer=window.requestAnimationFrame(e)};this.scrollTimer=window.requestAnimationFrame(e)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}calculateReward(t){return Math.max(3500,Math.round(t*.002))}formatAmount(t,o){return o!==void 0?Number(t).toLocaleString(void 0,{minimumFractionDigits:o,maximumFractionDigits:o}):Number(t).toLocaleString()}}class L extends u{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(t){super.oninit(t),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{const[t,o,r]=await Promise.all([n.store.find("loan-platforms"),n.store.find("loan-applications",{filter:{approved:"1"}}),n.store.find("loan-virtual-approvals")]);this.platforms=Array.isArray(t)?t.filter(s=>s!=null):[],this.approvedApplications=Array.isArray(o)?o.filter(s=>s!=null):[],this.virtualApprovals=Array.isArray(r)?r.filter(s=>s!=null):[]}catch(t){console.error("Failed to load loan data:",t),this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}finally{this.loading=!1,a.redraw()}}view(){return this.loading?a("div",{className:"LoanPage"},"加载中..."):a("div",{className:"LoanPage"},a("h2",null,"贷款申请"),a(N,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),a(y,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(t){await n.request({method:"POST",url:n.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:t}}}),n.alerts.show({type:"success"},"提交成功，等待审核")}}class b extends l{constructor(){super(...arguments),this.name=l.attribute("name"),this.logoUrl=l.attribute("logoUrl"),this.sponsorLinkUrl=l.attribute("sponsorLinkUrl"),this.currencyImageUrl=l.attribute("currencyImageUrl"),this.sortOrder=l.attribute("sortOrder")}}class w extends l{constructor(){super(...arguments),this.sponsorAccount=l.attribute("sponsorAccount"),this.applicantAccount=l.attribute("applicantAccount"),this.status=l.attribute("status"),this.approvedAmount=l.attribute("approvedAmount"),this.createdAt=l.attribute("createdAt"),this.reviewedAt=l.attribute("reviewedAt"),this.user=l.hasOne("user"),this.platform=l.hasOne("platform")}}class S extends l{constructor(){super(...arguments),this.fakeUsername=l.attribute("fakeUsername"),this.fakeAvatarUrl=l.attribute("fakeAvatarUrl"),this.amount=l.attribute("amount"),this.platform=l.hasOne("platform")}}n.initializers.add("wusong8899-loan",()=>{n.routes["wusong8899.loan"]={path:"/loan",component:L},n.store.models["loan-platforms"]=b,n.store.models["loan-applications"]=w,n.store.models["loan-virtual-approvals"]=S})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],m,flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};