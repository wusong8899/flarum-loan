(function(s,n,p,c,u,d,h,o,t){"use strict";class f extends n{constructor(){super(...arguments),this.loading=!1}oninit(r){super.oninit(r),this.platformId=u(""),this.message=u(""),this.loading=!1}view(){const r=this.attrs.platforms||[];return m("div",{className:"LoanApplicationForm"},m("div",{className:"Form-group"},m("label",null,"选择平台"),m(c,{value:this.platformId(),onchange:this.platformId,options:r.reduce((e,i)=>(e[String(i.id())]=m("div",{className:"PlatformOption"},m("img",{src:i.logoUrl(),alt:i.name()}),m("span",null,i.name())),e),{})})),m("div",{className:"Form-group"},m("label",null,"留言"),m("textarea",{className:"FormControl",value:this.message(),oninput:e=>this.message(e.target.value),placeholder:"请输入您的留言...",rows:"4"})),m(p,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.message(),onclick:this.submit.bind(this)},"提交申请"))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),message:this.message()}),this.platformId(""),this.message("")}finally{this.loading=!1}}}}class v extends n{view(){const{applications:r=[],virtualApprovals:e=[]}=this.attrs,i=[...r.map(a=>({type:"real",id:a.id(),username:h(a.user()||null),avatar:d(a.user()||null),platform:a.platform(),amount:a.approvedAmount()})),...e.map(a=>({type:"virtual",id:a.id(),username:a.fakeUsername(),avatar:m("img",{src:a.fakeAvatarUrl(),className:"Avatar"}),platform:a.platform(),amount:a.amount()}))];return i.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList"},m("h3",null,"申请通过列表"),m("div",{className:"ApprovalCards"},i.map(a=>m("div",{className:"ApprovalCard",key:a.id},m("div",{className:"ApprovalCard-user"},a.avatar,m("span",{className:"username"},a.username)),m("div",{className:"ApprovalCard-platform"},m("img",{src:a.platform.logoUrl?.(),alt:a.platform.name?.(),className:"platform-logo"}),m("span",{className:"platform-name"},a.platform.name?.())),m("div",{className:"ApprovalCard-amount"},m("span",{className:"amount-label"},"获批额度"),m("span",{className:"amount-value"},"¥",a.amount))))))}}class g extends n{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(r){super.oninit(r),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{this.platforms=await s.store.find("loan-platforms"),this.approvedApplications=await s.store.find("loan-applications",{filter:{approved:"1"}}),this.virtualApprovals=await s.store.find("loan-virtual-approvals")}finally{this.loading=!1,o.redraw()}}view(){return this.loading?o("div",{className:"LoanPage"},"加载中..."):o("div",{className:"LoanPage"},o("h2",null,"贷款申请"),o(f,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),o(v,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(r){await s.request({method:"POST",url:s.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:r}}}),s.alerts.show({type:"success"},"提交成功，等待审核")}}class A extends t{constructor(){super(...arguments),this.name=t.attribute("name"),this.logoUrl=t.attribute("logoUrl"),this.sortOrder=t.attribute("sortOrder")}}class b extends t{constructor(){super(...arguments),this.message=t.attribute("message"),this.status=t.attribute("status"),this.approvedAmount=t.attribute("approvedAmount"),this.createdAt=t.attribute("createdAt"),this.reviewedAt=t.attribute("reviewedAt"),this.user=t.hasOne("user"),this.platform=t.hasOne("platform")}}class N extends t{constructor(){super(...arguments),this.fakeUsername=t.attribute("fakeUsername"),this.fakeAvatarUrl=t.attribute("fakeAvatarUrl"),this.amount=t.attribute("amount"),this.platform=t.hasOne("platform")}}s.initializers.add("wusong8899-loan",()=>{s.routes["wusong8899.loan"]={path:"/loan",component:g},s.store.models["loan-platforms"]=A,s.store.models["loan-applications"]=b,s.store.models["loan-virtual-approvals"]=N})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Select"],flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],m,flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};