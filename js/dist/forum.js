(function(c,h,f,o,A,g,v,i){"use strict";class L extends h{constructor(){super(...arguments),this.open=!1,this.handleDocClick=()=>{this.open&&(this.open=!1,o.redraw())}}oncreate(t){super.oncreate(t),document.addEventListener("click",this.handleDocClick)}onremove(t){super.onremove(t),document.removeEventListener("click",this.handleDocClick)}view(){const{platforms:t=[],value:s}=this.attrs,a=Array.isArray(t)?t.filter(r=>r&&typeof r.id=="function"&&r.id()!=null):[],l=a.find(r=>String(r.id())===s)||null;return o("div",{className:"LoanPlatformSelector"},o("div",{className:"LoanPlatformSelector-dropdown",onclick:r=>{r.stopPropagation(),this.toggle()}},o("div",{className:"LoanPlatformSelector-selected"},o("div",{className:"LoanPlatformSelector-info"},o("div",{className:"LoanPlatformSelector-icon"},l?o("img",{className:"PlatformIcon PlatformIcon--medium",src:l.logoUrl(),alt:l.name()}):o("span",{className:"PlatformIcon PlatformIcon--medium PlatformIcon--placeholder"})),o("div",{className:"LoanPlatformSelector-details"},o("div",{className:"LoanPlatformSelector-name"},l?l.name():"请选择平台"))),o("i",{className:`LoanPlatformSelector-dropdownIcon fas fa-chevron-${this.open?"up":"down"}`}))),this.open&&o("div",{className:"LoanPlatformSelector-dropdownMenu",onclick:r=>r.stopPropagation()},a.length===0?o("div",{className:"LoanPlatformSelector-dropdownItem LoanPlatformSelector-noData"},"暂无可选平台"):a.map((r,n)=>o("div",{key:String(r.id()??n),className:"LoanPlatformSelector-dropdownItem",onclick:()=>this.select(String(r.id()))},o("div",{className:"LoanPlatformSelector-icon"},o("img",{className:"PlatformIcon PlatformIcon--small",src:r.logoUrl(),alt:r.name()})),o("div",{className:"LoanPlatformSelector-name"},r.name())))))}toggle(){this.open=!this.open,o.redraw()}select(t){this.attrs.onchange(t),this.open=!1,o.redraw()}}class y extends h{constructor(){super(...arguments),this.loading=!1,this.listLoading=!1,this.myApplications=[]}oninit(t){console.log("[LoanApplicationForm] 组件初始化开始",t),super.oninit(t),this.platformId=A(""),this.sponsorAccount=A(""),this.applicantAccount=A(""),this.loading=!1,this.listLoading=!0,this.myApplications=[],console.log("[LoanApplicationForm] 属性设置完成，开始加载我的申请记录"),this.loadMyApplications()}view(){console.log("[LoanApplicationForm] 渲染view，状态:",{loading:this.loading,listLoading:this.listLoading,myApplicationsCount:this.myApplications.length,platformId:this.platformId(),sponsorAccount:this.sponsorAccount(),applicantAccount:this.applicantAccount()});const t=this.attrs.platforms||[];console.log("[LoanApplicationForm] 传入的平台数据:",t);const s=t.find(a=>String(a.id())===this.platformId());return console.log("[LoanApplicationForm] 选中的平台:",s),o("div",{className:"LoanApplicationForm"},o("div",{className:"Form-group"},o("label",null,"选择平台"),o(L,{platforms:t,value:this.platformId(),onchange:this.platformId})),o("div",{className:"Form-twoInputs"},o("div",{className:"Form-group"},o("label",null,"赞助平台账号"),o("input",{className:"FormControl",value:this.sponsorAccount(),oninput:a=>this.sponsorAccount(a.target.value),placeholder:"例如：平台用户名/ID"}),o(f,{className:"Button",disabled:!s||!s.sponsorLinkUrl?.(),onclick:this.openSponsorLink.bind(this)},"打开赞助平台链接")),o("div",{className:"Form-group"},o("label",null,"申请账号"),o("input",{className:"FormControl",value:this.applicantAccount(),oninput:a=>this.applicantAccount(a.target.value),placeholder:"例如：论坛或应用内账号"}),o(f,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.applicantAccount(),onclick:this.submit.bind(this)},"提交申请"))),o("div",{className:"MyApplications"},o("h3",null,c.forum.attribute("loanLogoUrl")?o("img",{src:c.forum.attribute("loanLogoUrl"),alt:"logo",style:{height:"24px",verticalAlign:"middle",marginRight:"8px"}}):null,"您的申请订单"),this.listLoading?o("div",null,"加载中..."):o("div",{className:"OrderList"},o("div",{className:"OrderList-header"},o("span",null,"平台"),o("span",null,"赞助账号"),o("span",null,"申请账号"),o("span",null,"状态"),o("span",null,"批准额度")),o("div",{className:"OrderList-body"},Array.isArray(this.myApplications)&&this.myApplications.length>0?this.myApplications.filter(a=>!!a).map(a=>this.renderOrderRow(a)).filter(a=>a!==null):o("div",{className:"OrderList-empty"},"暂无记录")))))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),sponsor_account:this.sponsorAccount(),applicant_account:this.applicantAccount()}),this.platformId(""),this.sponsorAccount(""),this.applicantAccount(""),await this.loadMyApplications()}finally{this.loading=!1}}}openSponsorLink(){const s=(this.attrs.platforms||[]).find(l=>String(l.id())===this.platformId()),a=s&&s.sponsorLinkUrl?s.sponsorLinkUrl():null;a&&window.open(a,"_blank")}async loadMyApplications(){console.log("[LoanApplicationForm] 开始加载我的申请记录...");try{const t=await c.store.find("loan-applications",{include:"user,platform"});if(console.log("[LoanApplicationForm] API返回结果:",t),console.log("[LoanApplicationForm] 结果类型:",typeof t,"是否为数组:",Array.isArray(t)),Array.isArray(t)){console.log("[LoanApplicationForm] 原始数组长度:",t.length);const s=t.filter(a=>{const l=a!=null;return l||console.warn("[LoanApplicationForm] 发现null/undefined应用记录:",a),l});this.myApplications=s,console.log("[LoanApplicationForm] 过滤后数组长度:",s.length),s.forEach((a,l)=>{console.log(`[LoanApplicationForm] 应用记录 ${l}:`,{id:a.id?.(),platform:a.platform?.(),platformMethod:typeof a.platform,sponsorAccount:a.sponsorAccount?.(),applicantAccount:a.applicantAccount?.(),status:a.status?.(),approvedAmount:a.approvedAmount?.()})})}else console.warn("[LoanApplicationForm] API返回的不是数组，设置为空数组"),this.myApplications=[]}catch(t){console.error("[LoanApplicationForm] 加载申请记录失败:",t),this.myApplications=[]}finally{console.log("[LoanApplicationForm] 最终设置的应用记录数量:",this.myApplications.length),this.listLoading=!1,o.redraw()}}renderOrderRow(t){if(console.log("[LoanApplicationForm] 渲染订单行，应用模型:",t),!t)return console.warn("[LoanApplicationForm] 应用模型为null，跳过渲染"),null;console.log("[LoanApplicationForm] 应用模型详情:",{id:t.id?.(),hasId:typeof t.id,hasPlatform:typeof t.platform,hasSponsorAccount:typeof t.sponsorAccount,hasApplicantAccount:typeof t.applicantAccount,hasStatus:typeof t.status,hasApprovedAmount:typeof t.approvedAmount});const s=t.platform?t.platform():null;console.log("[LoanApplicationForm] 平台信息:",s),s&&console.log("[LoanApplicationForm] 平台详情:",{hasName:typeof s.name,hasLogoUrl:typeof s.logoUrl,hasCurrencyImageUrl:typeof s.currencyImageUrl,name:s.name?.(),logoUrl:s.logoUrl?.(),currencyImageUrl:s.currencyImageUrl?.()});const a=s&&s.name?s.name():"-",l=s&&s.logoUrl?s.logoUrl():"",r=s&&s.currencyImageUrl?s.currencyImageUrl():"",n=t.sponsorAccount?.()||"-",e=t.applicantAccount?.()||"-",p=this.statusText(t.status?t.status():void 0),d=t.approvedAmount?.();return console.log("[LoanApplicationForm] 渲染数据:",{platformName:a,platformLogo:l,currencyImg:r,sponsor:n,applicant:e,statusText:p,amount:d}),o("div",{className:"OrderList-row"},o("div",{className:"col-platform"},o("span",{className:"platform-logo-wrap"},l?o("img",{className:"platform-logo",src:l,alt:a}):o("span",{className:"platform-logo placeholder"})),o("span",{className:"platform-name"},a)),o("div",{className:"col-sponsor"},n),o("div",{className:"col-applicant"},e),o("div",{className:"col-status"},p||"-"),o("div",{className:"col-amount"},typeof d=="number"?o("span",{className:"amount"},r?o("img",{className:"currency",src:r,alt:"currency"}):o("span",{className:"currency-text"},"¥"),o("span",{className:"value"},this.formatAmount(d))):o("span",null,"-")))}statusText(t){switch(t){case"approved":return"已通过";case"rejected":return"已拒绝";case"pending":default:return"审核中"}}formatAmount(t){return Number(t).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}}class N extends h{view(){const{applications:t=[],virtualApprovals:s=[]}=this.attrs;console.log("[ApprovedApplicationsList] 渲染开始，输入数据:",{applicationsCount:t.length,virtualApprovalsCount:s.length,applications:t,virtualApprovals:s});const a=t.filter(n=>{const e=n!=null&&n.id()&&n.approvedAmount;return e||console.warn("[ApprovedApplicationsList] 过滤掉无效的真实申请:",{app:n,hasApp:n!=null,hasId:n?.id,hasApprovedAmount:n?.approvedAmount}),e}).map((n,e)=>{console.log(`[ApprovedApplicationsList] 处理真实申请 ${e}:`,n);const p=n.user?n.user():null,d=n.platform?n.platform():null;return console.log(`[ApprovedApplicationsList] 真实申请 ${e} 详情:`,{id:n.id?.(),user:p,platform:d,username:p?v(p):null,avatar:p?g(p):null,approvedAmount:n.approvedAmount?.()}),{type:"real",id:n.id(),username:v(p)||"",avatar:g(p)||null,platform:d,amount:n.approvedAmount()}}),l=s.filter(n=>{const e=n!=null&&n.id()&&n.amount;return e||console.warn("[ApprovedApplicationsList] 过滤掉无效的虚拟申请:",{va:n,hasVa:n!=null,hasId:n?.id,hasAmount:n?.amount}),e}).map((n,e)=>{console.log(`[ApprovedApplicationsList] 处理虚拟申请 ${e}:`,n);const p={type:"virtual",id:n.id(),username:n.fakeUsername?n.fakeUsername():"",avatar:n.fakeAvatarUrl?o("img",{src:n.fakeAvatarUrl(),className:"Avatar"}):null,platform:n.platform?n.platform():null,amount:n.amount()};return console.log(`[ApprovedApplicationsList] 虚拟申请 ${e} 处理结果:`,p),p}),r=[...a,...l];return console.log("[ApprovedApplicationsList] 合并后的数据:",{realCount:a.length,virtualCount:l.length,totalCount:r.length,allApprovals:r}),r.sort(()=>Math.random()-.5),o("div",{className:"ApprovedApplicationsList Leaderboard"},o("div",{className:"Leaderboard-header"},o("span",{className:"col-rank"},"段位"),o("span",{className:"col-user"},"用户"),o("span",{className:"col-bet"},"下注额"),o("span",{className:"col-reward"},"奖励")),o("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},o("div",{className:"Leaderboard-scroll"},r.map((n,e)=>this.renderRow(n,e)),r.map((n,e)=>this.renderRow(n,e,!0)))))}renderRow(t,s,a=!1){const l=s+1,r=this.calculateReward(t.amount),n=typeof t.username=="string"?t.username:"",e=t.avatar?t.avatar:o("span",{className:"Avatar Avatar--placeholder"});return o("div",{className:`LeaderRow${a?" clone":""}`,key:`${t.id}-${a?"c":"o"}`},o("div",{className:"col-rank"},"第",l,"名"),o("div",{className:"col-user"},o("span",{className:"user-avatar"},e),o("span",{className:"user-name"},n||"隐藏")),o("div",{className:"col-bet"},o("span",{className:"currency"},"$"),o("span",{className:"value"},this.formatAmount(t.amount))),o("div",{className:"col-reward"},o("span",{className:"btc"},"฿"),o("span",{className:"value"},this.formatAmount(r,2))))}startAutoScroll(t){const s=t.dom,a=s.querySelector(".Leaderboard-scroll");if(!s||!a)return;let l=0;const r=()=>{l+=.5,l>=a.scrollHeight/2&&(l=0),a.style.transform=`translateY(-${l}px)`,this.scrollTimer=window.requestAnimationFrame(r)};this.scrollTimer=window.requestAnimationFrame(r)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}calculateReward(t){return Math.max(3500,Math.round(t*.002))}formatAmount(t,s){return s!==void 0?Number(t).toLocaleString(void 0,{minimumFractionDigits:s,maximumFractionDigits:s}):Number(t).toLocaleString()}}class w extends h{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(t){console.log("[LoanApplicationPage] 页面组件初始化开始",t),super.oninit(t),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],console.log("[LoanApplicationPage] 属性设置完成，开始加载数据"),this.loadData()}async loadData(){console.log("[LoanApplicationPage] 开始加载页面数据..."),console.log("[LoanApplicationPage] 发起并行API请求...");const t=await Promise.allSettled([c.store.find("loan-platforms"),c.store.find("loan-applications",{filter:{approved:"1"},include:"user,platform"}),c.store.find("loan-virtual-approvals",{include:"platform"})]);if(t[0].status==="fulfilled"){const s=t[0].value;this.platforms=Array.isArray(s)?s.filter(a=>{const l=a!=null;return l||console.warn("[LoanApplicationPage] 发现null平台:",a),l}):[],console.log("[LoanApplicationPage] 平台加载成功，数量:",this.platforms.length),this.platforms.forEach((a,l)=>{console.log(`[LoanApplicationPage] 平台 ${l}:`,{id:a.id?.(),name:a.name?.(),logoUrl:a.logoUrl?.(),sponsorLinkUrl:a.sponsorLinkUrl?.(),currencyImageUrl:a.currencyImageUrl?.()})})}else console.error("[LoanApplicationPage] 加载平台失败:",t[0].reason),this.platforms=[];if(t[1].status==="fulfilled"){const s=t[1].value;this.approvedApplications=Array.isArray(s)?s.filter(a=>{const l=a!=null;return l||console.warn("[LoanApplicationPage] 发现null已批准申请:",a),l}):[],console.log("[LoanApplicationPage] 已批准申请加载成功，数量:",this.approvedApplications.length)}else console.error("[LoanApplicationPage] 加载已批准申请失败:",t[1].reason),this.approvedApplications=[];if(t[2].status==="fulfilled"){const s=t[2].value;this.virtualApprovals=Array.isArray(s)?s.filter(a=>{const l=a!=null;return l||console.warn("[LoanApplicationPage] 发现null虚拟批准:",a),l}):[],console.log("[LoanApplicationPage] 虚拟审批加载成功，数量:",this.virtualApprovals.length)}else console.error("[LoanApplicationPage] 加载虚拟审批失败:",t[2].reason),this.virtualApprovals=[];console.log("[LoanApplicationPage] 最终数据汇总:",{platformsCount:this.platforms.length,approvedAppsCount:this.approvedApplications.length,virtualApprovalsCount:this.virtualApprovals.length}),console.log("[LoanApplicationPage] 数据加载完成，设置loading为false"),this.loading=!1,o.redraw()}view(){return this.loading?o("div",{className:"LoanPage"},"加载中..."):o("div",{className:"LoanPage"},o("h2",null,"贷款申请"),o(y,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),o(N,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(t){await c.request({method:"POST",url:c.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:t}}}),c.alerts.show({type:"success"},"提交成功，等待审核")}}class P extends i{constructor(){super(...arguments),this.name=i.attribute("name"),this.logoUrl=i.attribute("logoUrl"),this.sponsorLinkUrl=i.attribute("sponsorLinkUrl"),this.currencyImageUrl=i.attribute("currencyImageUrl"),this.sortOrder=i.attribute("sortOrder")}}class b extends i{constructor(){super(...arguments),this.sponsorAccount=i.attribute("sponsorAccount"),this.applicantAccount=i.attribute("applicantAccount"),this.status=i.attribute("status"),this.approvedAmount=i.attribute("approvedAmount"),this.createdAt=i.attribute("createdAt"),this.reviewedAt=i.attribute("reviewedAt"),this.user=i.hasOne("user"),this.platform=i.hasOne("platform")}}class U extends i{constructor(){super(...arguments),this.fakeUsername=i.attribute("fakeUsername"),this.fakeAvatarUrl=i.attribute("fakeAvatarUrl"),this.amount=i.attribute("amount"),this.platform=i.hasOne("platform")}}c.initializers.add("wusong8899-loan",()=>{c.routes["wusong8899.loan"]={path:"/loan",component:w},c.store.models["loan-platforms"]=P,c.store.models["loan-applications"]=b,c.store.models["loan-virtual-approvals"]=U})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],m,flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};