(function(n,c,h,a,p,v,A,e){"use strict";class g extends c{constructor(){super(...arguments),this.open=!1,this.handleDocClick=()=>{this.open&&(this.open=!1,a.redraw())}}view(){const{platforms:t=[],value:r}=this.attrs,o=t.find(s=>String(s.id())===r)||null;return a("div",{className:"LoanPlatformSelector",oncreate:()=>document.addEventListener("click",this.handleDocClick),onremove:()=>document.removeEventListener("click",this.handleDocClick)},a("div",{className:"LoanPlatformSelector-dropdown",onclick:s=>{s.stopPropagation(),this.toggle()}},a("div",{className:"LoanPlatformSelector-selected"},a("div",{className:"LoanPlatformSelector-info"},a("div",{className:"LoanPlatformSelector-icon"},o?a("img",{className:"PlatformIcon PlatformIcon--medium",src:o.logoUrl(),alt:o.name()}):a("span",{className:"PlatformIcon PlatformIcon--medium"})),a("div",{className:"LoanPlatformSelector-details"},a("div",{className:"LoanPlatformSelector-name"},o?o.name():"请选择平台")))),a("i",{className:"LoanPlatformSelector-dropdownIcon fas fa-chevron-down"})),this.open&&a("div",{className:"LoanPlatformSelector-dropdownMenu",onclick:s=>s.stopPropagation()},t.length===0?a("div",{className:"LoanPlatformSelector-dropdownItem LoanPlatformSelector-noData"},"暂无可选平台"):t.map(s=>a("div",{className:"LoanPlatformSelector-dropdownItem",onclick:()=>this.select(String(s.id()))},a("div",{className:"LoanPlatformSelector-icon"},a("img",{className:"PlatformIcon PlatformIcon--small",src:s.logoUrl(),alt:s.name()})),a("div",{className:"LoanPlatformSelector-name"},s.name())))))}toggle(){this.open=!this.open}select(t){this.attrs.onchange(t),this.open=!1}}class N extends c{constructor(){super(...arguments),this.loading=!1,this.listLoading=!1,this.myApplications=[]}oninit(t){super.oninit(t),this.platformId=p(""),this.sponsorAccount=p(""),this.applicantAccount=p(""),this.loading=!1,this.listLoading=!0,this.myApplications=[],this.loadMyApplications()}view(){const t=this.attrs.platforms||[],r=t.find(o=>String(o.id())===this.platformId());return a("div",{className:"LoanApplicationForm"},a("div",{className:"Form-group"},a("label",null,"选择平台"),a(g,{platforms:t,value:this.platformId(),onchange:this.platformId})),a("div",{className:"Form-twoInputs"},a("div",{className:"Form-group"},a("label",null,"赞助平台账号"),a("input",{className:"FormControl",value:this.sponsorAccount(),oninput:o=>this.sponsorAccount(o.target.value),placeholder:"例如：平台用户名/ID"}),a(h,{className:"Button",disabled:!r||!r.sponsorLinkUrl?.(),onclick:this.openSponsorLink.bind(this)},"打开赞助平台链接")),a("div",{className:"Form-group"},a("label",null,"申请账号"),a("input",{className:"FormControl",value:this.applicantAccount(),oninput:o=>this.applicantAccount(o.target.value),placeholder:"例如：论坛或应用内账号"}),a(h,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.applicantAccount(),onclick:this.submit.bind(this)},"提交申请"))),a("div",{className:"MyApplications"},a("h3",null,"您的申请订单"),this.listLoading?a("div",null,"加载中..."):a("div",{className:"OrderList"},a("div",{className:"OrderList-header"},a("span",null,"平台"),a("span",null,"赞助账号"),a("span",null,"申请账号"),a("span",null,"状态"),a("span",null,"批准额度")),a("div",{className:"OrderList-body"},Array.isArray(this.myApplications)&&this.myApplications.length>0?this.myApplications.filter(o=>!!o).map(o=>this.renderOrderRow(o)):a("div",{className:"OrderList-empty"},"暂无记录")))))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),sponsor_account:this.sponsorAccount(),applicant_account:this.applicantAccount()}),this.platformId(""),this.sponsorAccount(""),this.applicantAccount(""),await this.loadMyApplications()}finally{this.loading=!1}}}openSponsorLink(){const r=(this.attrs.platforms||[]).find(s=>String(s.id())===this.platformId()),o=r&&r.sponsorLinkUrl?r.sponsorLinkUrl():null;o&&window.open(o,"_blank")}async loadMyApplications(){try{this.myApplications=await n.store.find("loan-applications")}finally{this.listLoading=!1,a.redraw()}}renderOrderRow(t){const r=t.platform(),o=r&&r.name?r.name():"-",s=r&&r.logoUrl?r.logoUrl():null,i=r&&r.currencyImageUrl?r.currencyImageUrl():null,u=t.sponsorAccount?.()||"-",d=t.applicantAccount?.()||"-",P=this.statusText(t.status()),f=t.approvedAmount?.();return a("div",{className:"OrderList-row"},a("div",{className:"col-platform"},a("span",{className:"platform-logo-wrap"},s?a("img",{className:"platform-logo",src:s,alt:o}):a("span",{className:"platform-logo placeholder"})),a("span",{className:"platform-name"},o)),a("div",{className:"col-sponsor"},u),a("div",{className:"col-applicant"},d),a("div",{className:"col-status"},P||"-"),a("div",{className:"col-amount"},typeof f=="number"?a("span",{className:"amount"},i?a("img",{className:"currency",src:i,alt:"currency"}):a("span",{className:"currency-text"},"¥"),a("span",{className:"value"},this.formatAmount(f))):a("span",null,"-")))}statusText(t){switch(t){case"approved":return"已通过";case"rejected":return"已拒绝";case"pending":default:return"审核中"}}formatAmount(t){return Number(t).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}}class L extends c{view(){const{applications:t=[],virtualApprovals:r=[]}=this.attrs,o=[...t.map(s=>({type:"real",id:s.id(),username:A(s.user()||null)||"",avatar:v(s.user()||null)||null,platform:s.platform(),amount:s.approvedAmount()})),...r.map(s=>({type:"virtual",id:s.id(),username:s.fakeUsername()||"",avatar:m("img",{src:s.fakeAvatarUrl(),className:"Avatar"}),platform:s.platform(),amount:s.amount()}))];return o.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-header"},m("span",{className:"col-rank"},"段位"),m("span",{className:"col-user"},"用户"),m("span",{className:"col-bet"},"下注额"),m("span",{className:"col-reward"},"奖励")),m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},o.map((s,i)=>this.renderRow(s,i)),o.map((s,i)=>this.renderRow(s,i,!0)))))}renderRow(t,r,o=!1){const s=r+1,i=this.calculateReward(t.amount),u=typeof t.username=="string"?t.username:"",d=t.avatar?t.avatar:m("span",{className:"Avatar Avatar--placeholder"});return m("div",{className:`LeaderRow${o?" clone":""}`,key:`${t.id}-${o?"c":"o"}`},m("div",{className:"col-rank"},"第",s,"名"),m("div",{className:"col-user"},m("span",{className:"user-avatar"},d),m("span",{className:"user-name"},u||"隐藏")),m("div",{className:"col-bet"},m("span",{className:"currency"},"$"),m("span",{className:"value"},this.formatAmount(t.amount))),m("div",{className:"col-reward"},m("span",{className:"btc"},"฿"),m("span",{className:"value"},this.formatAmount(i,2))))}startAutoScroll(t){const r=t.dom,o=r.querySelector(".Leaderboard-scroll");if(!r||!o)return;let s=0;const i=()=>{s+=.5,s>=o.scrollHeight/2&&(s=0),o.style.transform=`translateY(-${s}px)`,this.scrollTimer=window.requestAnimationFrame(i)};this.scrollTimer=window.requestAnimationFrame(i)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}calculateReward(t){return Math.max(3500,Math.round(t*.002))}formatAmount(t,r){return r!==void 0?Number(t).toLocaleString(void 0,{minimumFractionDigits:r,maximumFractionDigits:r}):Number(t).toLocaleString()}}class b extends c{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(t){super.oninit(t),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{this.platforms=await n.store.find("loan-platforms"),this.approvedApplications=await n.store.find("loan-applications",{filter:{approved:"1"}}),this.virtualApprovals=await n.store.find("loan-virtual-approvals")}finally{this.loading=!1,a.redraw()}}view(){return this.loading?a("div",{className:"LoanPage"},"加载中..."):a("div",{className:"LoanPage"},a("h2",null,"贷款申请"),a(N,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),a(L,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(t){await n.request({method:"POST",url:n.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:t}}}),n.alerts.show({type:"success"},"提交成功，等待审核")}}class w extends e{constructor(){super(...arguments),this.name=e.attribute("name"),this.logoUrl=e.attribute("logoUrl"),this.sponsorLinkUrl=e.attribute("sponsorLinkUrl"),this.currencyImageUrl=e.attribute("currencyImageUrl"),this.sortOrder=e.attribute("sortOrder")}}class y extends e{constructor(){super(...arguments),this.sponsorAccount=e.attribute("sponsorAccount"),this.applicantAccount=e.attribute("applicantAccount"),this.status=e.attribute("status"),this.approvedAmount=e.attribute("approvedAmount"),this.createdAt=e.attribute("createdAt"),this.reviewedAt=e.attribute("reviewedAt"),this.user=e.hasOne("user"),this.platform=e.hasOne("platform")}}class S extends e{constructor(){super(...arguments),this.fakeUsername=e.attribute("fakeUsername"),this.fakeAvatarUrl=e.attribute("fakeAvatarUrl"),this.amount=e.attribute("amount"),this.platform=e.hasOne("platform")}}n.initializers.add("wusong8899-loan",()=>{n.routes["wusong8899.loan"]={path:"/loan",component:b},n.store.models["loan-platforms"]=w,n.store.models["loan-applications"]=y,n.store.models["loan-virtual-approvals"]=S})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],m,flarum.core.compat["common/utils/Stream"],flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};