(function(n,c,d,f,u,t,v,A,i){"use strict";class g extends c{constructor(){super(...arguments),this.loading=!1,this.listLoading=!1,this.myApplications=[]}oninit(a){super.oninit(a),this.platformId=u(""),this.sponsorAccount=u(""),this.applicantAccount=u(""),this.loading=!1,this.listLoading=!0,this.myApplications=[],this.loadMyApplications()}view(){const a=this.attrs.platforms||[],o=a.find(r=>String(r.id())===this.platformId());return t("div",{className:"LoanApplicationForm"},t("div",{className:"Form-group"},t("label",null,"选择平台"),t(f,{value:this.platformId(),onchange:this.platformId,options:a.reduce((r,s)=>(r[String(s.id())]=t("div",{className:"PlatformOption"},t("img",{src:s.logoUrl(),alt:s.name()}),t("span",null,s.name())),r),{})})),t("div",{className:"Form-twoInputs"},t("div",{className:"Form-group"},t("label",null,"赞助平台账号"),t("input",{className:"FormControl",value:this.sponsorAccount(),oninput:r=>this.sponsorAccount(r.target.value),placeholder:"例如：平台用户名/ID"}),t(d,{className:"Button",disabled:!o||!o.sponsorLinkUrl?.(),onclick:this.openSponsorLink.bind(this)},"打开赞助平台链接")),t("div",{className:"Form-group"},t("label",null,"申请账号"),t("input",{className:"FormControl",value:this.applicantAccount(),oninput:r=>this.applicantAccount(r.target.value),placeholder:"例如：论坛或应用内账号"}),t(d,{className:"Button Button--primary",loading:this.loading,disabled:!this.platformId()||!this.sponsorAccount()||!this.applicantAccount(),onclick:this.submit.bind(this)},"提交申请"))),t("div",{className:"MyApplications"},t("h3",null,"您的申请订单"),this.listLoading?t("div",null,"加载中..."):t("div",{className:"OrderList"},t("div",{className:"OrderList-header"},t("span",null,"平台"),t("span",null,"赞助账号"),t("span",null,"申请账号"),t("span",null,"状态"),t("span",null,"批准额度")),t("div",{className:"OrderList-body"},Array.isArray(this.myApplications)&&this.myApplications.length>0?this.myApplications.filter(r=>!!r).map(r=>this.renderOrderRow(r)):t("div",{className:"OrderList-empty"},"暂无记录")))))}async submit(){if(!this.loading){this.loading=!0;try{await this.attrs.onSubmit({platform_id:this.platformId(),sponsor_account:this.sponsorAccount(),applicant_account:this.applicantAccount()}),this.platformId(""),this.sponsorAccount(""),this.applicantAccount(""),await this.loadMyApplications()}finally{this.loading=!1}}}openSponsorLink(){const o=(this.attrs.platforms||[]).find(s=>String(s.id())===this.platformId()),r=o&&o.sponsorLinkUrl?o.sponsorLinkUrl():null;r&&window.open(r,"_blank")}async loadMyApplications(){try{this.myApplications=await n.store.find("loan-applications")}finally{this.listLoading=!1,t.redraw()}}renderOrderRow(a){const o=a.platform(),r=o&&o.name?o.name():"-",s=o&&o.logoUrl?o.logoUrl():null,e=o&&o.currencyImageUrl?o.currencyImageUrl():null,p=a.sponsorAccount?.()||"-",U=a.applicantAccount?.()||"-",k=this.statusText(a.status()),h=a.approvedAmount?.();return t("div",{className:"OrderList-row"},t("div",{className:"col-platform"},t("span",{className:"platform-logo-wrap"},s?t("img",{className:"platform-logo",src:s,alt:r}):t("span",{className:"platform-logo placeholder"})),t("span",{className:"platform-name"},r)),t("div",{className:"col-sponsor"},p),t("div",{className:"col-applicant"},U),t("div",{className:"col-status"},k||"-"),t("div",{className:"col-amount"},typeof h=="number"?t("span",{className:"amount"},e?t("img",{className:"currency",src:e,alt:"currency"}):t("span",{className:"currency-text"},"¥"),t("span",{className:"value"},this.formatAmount(h))):t("span",null,"-")))}statusText(a){switch(a){case"approved":return"已通过";case"rejected":return"已拒绝";case"pending":default:return"审核中"}}formatAmount(a){return Number(a).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}}class N extends c{view(){const{applications:a=[],virtualApprovals:o=[]}=this.attrs,r=[...a.map(s=>({type:"real",id:s.id(),username:A(s.user()||null),avatar:v(s.user()||null),platform:s.platform(),amount:s.approvedAmount()})),...o.map(s=>({type:"virtual",id:s.id(),username:s.fakeUsername(),avatar:m("img",{src:s.fakeAvatarUrl(),className:"Avatar"}),platform:s.platform(),amount:s.amount()}))];return r.sort(()=>Math.random()-.5),m("div",{className:"ApprovedApplicationsList Leaderboard"},m("div",{className:"Leaderboard-header"},m("span",{className:"col-rank"},"段位"),m("span",{className:"col-user"},"用户"),m("span",{className:"col-bet"},"下注额"),m("span",{className:"col-reward"},"奖励")),m("div",{className:"Leaderboard-body",oncreate:this.startAutoScroll.bind(this),onremove:this.stopAutoScroll.bind(this)},m("div",{className:"Leaderboard-scroll"},r.map((s,e)=>this.renderRow(s,e)),r.map((s,e)=>this.renderRow(s,e,!0)))))}renderRow(a,o,r=!1){const s=o+1,e=this.calculateReward(a.amount),p=typeof a.username=="string"?a.username:"";return m("div",{className:`LeaderRow${r?" clone":""}`,key:`${a.id}-${r?"c":"o"}`},m("div",{className:"col-rank"},"第",s,"名"),m("div",{className:"col-user"},m("span",{className:"user-avatar"},a.avatar),m("span",{className:"user-name"},p||"隐藏")),m("div",{className:"col-bet"},m("span",{className:"currency"},"$"),m("span",{className:"value"},this.formatAmount(a.amount))),m("div",{className:"col-reward"},m("span",{className:"btc"},"฿"),m("span",{className:"value"},this.formatAmount(e,2))))}startAutoScroll(a){const o=a.dom,r=o.querySelector(".Leaderboard-scroll");if(!o||!r)return;let s=0;const e=()=>{s+=.5,s>=r.scrollHeight/2&&(s=0),r.style.transform=`translateY(-${s}px)`,this.scrollTimer=window.requestAnimationFrame(e)};this.scrollTimer=window.requestAnimationFrame(e)}stopAutoScroll(){this.scrollTimer&&cancelAnimationFrame(this.scrollTimer)}calculateReward(a){return Math.max(3500,Math.round(a*.002))}formatAmount(a,o){return o!==void 0?Number(a).toLocaleString(void 0,{minimumFractionDigits:o,maximumFractionDigits:o}):Number(a).toLocaleString()}}class b extends c{constructor(){super(...arguments),this.loading=!1,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[]}oninit(a){super.oninit(a),this.loading=!0,this.platforms=[],this.approvedApplications=[],this.virtualApprovals=[],this.loadData()}async loadData(){try{this.platforms=await n.store.find("loan-platforms"),this.approvedApplications=await n.store.find("loan-applications",{filter:{approved:"1"}}),this.virtualApprovals=await n.store.find("loan-virtual-approvals")}finally{this.loading=!1,t.redraw()}}view(){return this.loading?t("div",{className:"LoanPage"},"加载中..."):t("div",{className:"LoanPage"},t("h2",null,"贷款申请"),t(g,{platforms:this.platforms,onSubmit:this.submitApplication.bind(this)}),t(N,{applications:this.approvedApplications,virtualApprovals:this.virtualApprovals}))}async submitApplication(a){await n.request({method:"POST",url:n.forum.attribute("apiUrl")+"/loan-applications",body:{data:{attributes:a}}}),n.alerts.show({type:"success"},"提交成功，等待审核")}}class y extends i{constructor(){super(...arguments),this.name=i.attribute("name"),this.logoUrl=i.attribute("logoUrl"),this.sponsorLinkUrl=i.attribute("sponsorLinkUrl"),this.currencyImageUrl=i.attribute("currencyImageUrl"),this.sortOrder=i.attribute("sortOrder")}}class w extends i{constructor(){super(...arguments),this.sponsorAccount=i.attribute("sponsorAccount"),this.applicantAccount=i.attribute("applicantAccount"),this.status=i.attribute("status"),this.approvedAmount=i.attribute("approvedAmount"),this.createdAt=i.attribute("createdAt"),this.reviewedAt=i.attribute("reviewedAt"),this.user=i.hasOne("user"),this.platform=i.hasOne("platform")}}class L extends i{constructor(){super(...arguments),this.fakeUsername=i.attribute("fakeUsername"),this.fakeAvatarUrl=i.attribute("fakeAvatarUrl"),this.amount=i.attribute("amount"),this.platform=i.hasOne("platform")}}n.initializers.add("wusong8899-loan",()=>{n.routes["wusong8899.loan"]={path:"/loan",component:b},n.store.models["loan-platforms"]=y,n.store.models["loan-applications"]=w,n.store.models["loan-virtual-approvals"]=L})})(flarum.core.compat["forum/app"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Select"],flarum.core.compat["common/utils/Stream"],m,flarum.core.compat["common/helpers/avatar"],flarum.core.compat["common/helpers/username"],flarum.core.compat["common/Model"]);
//# sourceMappingURL=forum.js.map

module.exports={};