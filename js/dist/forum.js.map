{"version":3,"file":"forum.js","sources":["../src/forum/components/PlatformSelect.tsx","../src/common/constants/svgPaths.ts","../src/forum/components/LoanApplicationForm.tsx","../src/forum/components/ApprovedApplicationsList.tsx","../src/forum/components/LoanApplicationPage.tsx","../src/common/models/LoanPlatform.ts","../src/common/models/LoanApplication.ts","../src/common/models/LoanVirtualApproval.ts","../src/forum/index.ts"],"sourcesContent":["import Component from 'flarum/common/Component';\nimport m, { VnodeDOM } from 'mithril';\nimport LoanPlatform from '../../common/models/LoanPlatform';\n\ntype PlatformSelectAttrs = {\n  platforms: LoanPlatform[];\n  value: string;\n  onchange: (val: string) => void;\n};\n\nexport default class PlatformSelect extends Component<PlatformSelectAttrs> {\n  private open = false;\n\n  oncreate(vnode: VnodeDOM) {\n    super.oncreate(vnode);\n    document.addEventListener('click', this.handleDocClick);\n  }\n\n  onremove(vnode: VnodeDOM) {\n    super.onremove(vnode);\n    document.removeEventListener('click', this.handleDocClick);\n  }\n\n  view() {\n    const { platforms = [], value } = this.attrs as PlatformSelectAttrs;\n    const list = Array.isArray(platforms)\n      ? platforms.filter((p) => p && typeof (p as any).id === 'function' && (p as any).id() != null)\n      : [];\n    const selected = list.find((p) => String(p.id()) === value) || null;\n\n    return (\n      <div className=\"LoanPlatformSelector\">\n        <div className=\"LoanPlatformSelector-dropdown\" onclick={(e: MouseEvent) => { e.stopPropagation(); this.toggle(); }}>\n          <div className=\"LoanPlatformSelector-selected\">\n            <div className=\"LoanPlatformSelector-info\">\n              <div className=\"LoanPlatformSelector-icon\">\n                {selected ? (\n                  <img className=\"PlatformIcon PlatformIcon--medium\" src={selected.logoUrl()} alt={selected.name()} />\n                ) : (\n                  <span className=\"PlatformIcon PlatformIcon--medium PlatformIcon--placeholder\"></span>\n                )}\n              </div>\n              <div className=\"LoanPlatformSelector-details\">\n                <div className=\"LoanPlatformSelector-name\">{selected ? selected.name() : '请选择平台'}</div>\n              </div>\n            </div>\n            <i className={`LoanPlatformSelector-dropdownIcon fas fa-chevron-${this.open ? 'up' : 'down'}`}></i>\n          </div>\n        </div>\n\n        {this.open && (\n          <div className=\"LoanPlatformSelector-dropdownMenu\" onclick={(e: MouseEvent) => e.stopPropagation()}>\n            {list.length === 0 ? (\n              <div className=\"LoanPlatformSelector-dropdownItem LoanPlatformSelector-noData\">暂无可选平台</div>\n            ) : (\n              list.map((p, index) => (\n                <div\n                  key={String((p as any).id() ?? index)}\n                  className=\"LoanPlatformSelector-dropdownItem\"\n                  onclick={() => this.select(String((p as any).id()))}\n                >\n                  <div className=\"LoanPlatformSelector-icon\">\n                    <img className=\"PlatformIcon PlatformIcon--small\" src={(p as any).logoUrl()} alt={(p as any).name()} />\n                  </div>\n                  <div className=\"LoanPlatformSelector-name\">{(p as any).name()}</div>\n                </div>\n              ))\n            )}\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  private toggle() {\n    this.open = !this.open;\n    m.redraw();\n  }\n\n  private handleDocClick = () => {\n    if (this.open) {\n      this.open = false;\n      m.redraw();\n    }\n  };\n\n  private select(val: string) {\n    (this.attrs as PlatformSelectAttrs).onchange(val);\n    this.open = false;\n    m.redraw();\n  }\n}\n\n\n","// Centralized SVG path constants for reuse across forum/admin UIs\n\nexport const PLAY_ICON_PATH: string =\n  'M10.3259 3.91873C12.6748 5.25805 13.8493 5.92772 14.2435 6.802C14.5872 7.56458 14.5873 8.43542 14.2435 9.198C13.8493 10.0723 12.6748 10.7419 10.3259 12.0813C7.9769 13.4206 6.80242 14.0903 5.83867 13.9902C4.99805 13.903 4.2344 13.4675 3.73757 12.7922C3.16797 12.018 3.16797 10.6786 3.16797 8C3.16797 5.32135 3.16797 3.98203 3.73757 3.20778C4.2344 2.53245 4.99805 2.09703 5.83867 2.00978C6.80242 1.90974 7.9769 2.57941 10.3259 3.91873Z';\n","// js/src/forum/components/LoanApplicationForm.tsx\nimport Component from 'flarum/common/Component';\nimport Button from 'flarum/common/components/Button';\nimport PlatformSelect from './PlatformSelect';\nimport Stream from 'flarum/common/utils/Stream';\nimport m, { Vnode } from 'mithril';\nimport app from 'flarum/forum/app';\nimport LoanApplication from '../../common/models/LoanApplication';\nimport LoanPlatform from '../../common/models/LoanPlatform';\nimport { PLAY_ICON_PATH } from '../../common/constants/svgPaths';\n\ntype LoanApplicationFormAttrs = {\n  platforms: LoanPlatform[];\n  onSubmit: (payload: { platform_id: string; sponsor_account?: string; repayment_date?: string }) => Promise<void> | void;\n};\n\nexport default class LoanApplicationForm extends Component<LoanApplicationFormAttrs> {\n  private platformId: any;\n  private sponsorAccount: any;\n  private repaymentDate: any;\n  private loading: boolean = false;\n  private listLoading: boolean = false;\n  private myApplications: LoanApplication[] = [];\n\n  oninit(vnode: Vnode) {\n    console.log('[LoanApplicationForm] 组件初始化开始', vnode);\n    super.oninit(vnode);\n\n    this.platformId = Stream('');\n    this.sponsorAccount = Stream('');\n    this.repaymentDate = Stream('');\n    this.loading = false;\n    this.listLoading = true;\n    this.myApplications = [];\n\n    console.log('[LoanApplicationForm] 属性设置完成，开始加载我的申请记录');\n    this.loadMyApplications();\n  }\n\n  view() {\n    console.log('[LoanApplicationForm] 渲染view，状态:', {\n      loading: this.loading,\n      listLoading: this.listLoading,\n      myApplicationsCount: this.myApplications.length,\n      platformId: this.platformId(),\n      sponsorAccount: this.sponsorAccount(),\n      repaymentDate: this.repaymentDate()\n    });\n\n    const platforms = (this.attrs as LoanApplicationFormAttrs).platforms || [];\n    console.log('[LoanApplicationForm] 传入的平台数据:', platforms);\n\n    const selectedPlatform = platforms.find((p: LoanPlatform) => String(p.id()) === this.platformId());\n    const maxMonthsCfg = parseInt((app.forum.attribute('loanRepaymentMaxMonths') as any) || '6', 10);\n    const todayStr = this.formatDateYmdFromDate(new Date());\n    const maxDateStr = this.formatDateYmdFromDate(this.addMonths(new Date(), maxMonthsCfg));\n    console.log('[LoanApplicationForm] 选中的平台:', selectedPlatform);\n\n    return (\n      <div className=\"LoanApplicationForm\">\n        <div className=\"Form-group\">\n          <label>选择平台</label>\n          <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>\n            <PlatformSelect\n              platforms={platforms}\n              value={this.platformId()}\n              onchange={this.platformId}\n            />\n            {selectedPlatform?.sponsorLinkUrl?.() && (\n              <button\n                className=\"LoanRegisterButton\"\n                type=\"button\"\n                onclick={this.openSponsorLink.bind(this)}\n              >\n                <span className=\"register-icon\" aria-hidden=\"true\">\n                  <svg width=\"17\" height=\"17\" viewBox=\"0 0 17 16\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n                    <path d={PLAY_ICON_PATH} stroke=\"#FFFFFF\" />\n                  </svg>\n                </span>\n                注册\n              </button>\n            )}\n          </div>\n        </div>\n\n        <div className=\"Form-twoInputs\">\n          <div className=\"Form-group\">\n            <label>注册账号</label>\n            <input\n              className=\"FormControl\"\n              value={this.sponsorAccount()}\n              oninput={(e: InputEvent) => this.sponsorAccount((e.target as HTMLInputElement).value)}\n              placeholder=\"请输入贷款账号ID\"\n            />\n          </div>\n          <div className=\"Form-group\">\n            <label>还款日期</label>\n            <input\n              className=\"FormControl\"\n              type=\"date\"\n              min={todayStr}\n              max={maxDateStr}\n              value={this.repaymentDate()}\n              oninput={(e: InputEvent) => this.repaymentDate((e.target as HTMLInputElement).value)}\n              placeholder=\"请选择还款日期\"\n            />\n            <div className=\"helpText\">请输入{maxMonthsCfg}个月内还款日期</div>\n            <Button\n              className=\"Button Button--primary\"\n              loading={this.loading}\n              disabled={!this.platformId() || !this.sponsorAccount() || !this.repaymentDate()}\n              onclick={this.submit.bind(this)}\n            >\n              提交申请\n            </Button>\n          </div>\n        </div>\n        <div className=\"MyApplications\">\n          <h3>\n            {app.forum.attribute('loanLogoUrl') ? (\n              <img\n                src={app.forum.attribute('loanLogoUrl')}\n                alt=\"logo\"\n                style={{ height: '24px', verticalAlign: 'middle', marginRight: '8px' }}\n              />\n            ) : null}\n            您的申请订单\n          </h3>\n          {this.listLoading ? (\n            <div>加载中...</div>\n          ) : (\n            <div className=\"OrderList\">\n              <div className=\"OrderList-header\">\n                <span>平台</span>\n                <span>赞助账号</span>\n                <span>还款日期</span>\n                <span>状态</span>\n                <span>批准额度</span>\n              </div>\n              <div className=\"OrderList-body\">\n                {Array.isArray(this.myApplications) && this.myApplications.length > 0 ? (\n                  (this.myApplications as LoanApplication[])\n                    .filter((a) => !!a)\n                    .map((appModel: LoanApplication) => this.renderOrderRow(appModel))\n                    .filter((row) => row !== null) // 过滤掉renderOrderRow返回的null值\n                ) : (\n                  <div className=\"OrderList-empty\">暂无记录</div>\n                )}\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  async submit(): Promise<void> {\n    if (this.loading) return;\n\n    this.loading = true;\n\n    try {\n      await (this.attrs as LoanApplicationFormAttrs).onSubmit({\n        platform_id: this.platformId(),\n        sponsor_account: this.sponsorAccount(),\n        repayment_date: this.repaymentDate()\n      });\n\n      // 重置表单\n      this.platformId('');\n      this.sponsorAccount('');\n      this.repaymentDate('');\n\n      // 重新加载我的申请记录\n      await this.loadMyApplications();\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  openSponsorLink() {\n    const platforms = (this.attrs as LoanApplicationFormAttrs).platforms || [];\n    const platform = platforms.find((p: LoanPlatform) => String(p.id()) === this.platformId());\n    const url = platform && platform.sponsorLinkUrl ? platform.sponsorLinkUrl() : null;\n    if (url) {\n      window.open(url, '_blank');\n    }\n  }\n\n  async loadMyApplications(): Promise<void> {\n    console.log('[LoanApplicationForm] 开始加载我的申请记录...');\n    try {\n      const result = await app.store.find('loan-applications', { include: 'user,platform' }) as any;\n      console.log('[LoanApplicationForm] API返回结果:', result);\n      console.log('[LoanApplicationForm] 结果类型:', typeof result, '是否为数组:', Array.isArray(result));\n\n      // 确保结果是数组，过滤掉任何null/undefined值\n      if (Array.isArray(result)) {\n        console.log('[LoanApplicationForm] 原始数组长度:', result.length);\n        const filteredApps = result.filter(applicationModel => {\n          const isValid = applicationModel != null;\n          if (!isValid) {\n            console.warn('[LoanApplicationForm] 发现null/undefined应用记录:', applicationModel);\n          }\n          return isValid;\n        });\n\n        // 仅显示当前登录用户的申请（管理员在此区域也只显示自己的）\n        const currentUser = app.session.user;\n        const currentUserId = currentUser ? currentUser.id() : null;\n        const mineOnly = currentUserId\n          ? filteredApps.filter((applicationModel: LoanApplication) => {\n            try {\n              const userModel = applicationModel.user ? applicationModel.user() : null;\n              const userIdOfApplication = userModel && typeof (userModel as any).id === 'function' ? (userModel as any).id() : null;\n              return userIdOfApplication === currentUserId;\n            } catch (e) {\n              console.warn('[LoanApplicationForm] 读取应用用户失败:', e, applicationModel);\n              return false;\n            }\n          })\n          : [];\n\n        this.myApplications = mineOnly as any;\n        console.log('[LoanApplicationForm] 过滤为当前用户后的数组长度:', mineOnly.length);\n\n        // 检查每个应用记录的详细信息\n        filteredApps.forEach((app, index) => {\n          console.log(`[LoanApplicationForm] 应用记录 ${index}:`, {\n            id: app.id?.(),\n            platform: app.platform?.(),\n            platformMethod: typeof app.platform,\n            sponsorAccount: app.sponsorAccount?.(),\n            repaymentDate: app.repaymentDate?.(),\n            status: app.status?.(),\n            approvedAmount: app.approvedAmount?.()\n          });\n        });\n      } else {\n        console.warn('[LoanApplicationForm] API返回的不是数组，设置为空数组');\n        this.myApplications = [];\n      }\n    } catch (error) {\n      console.error('[LoanApplicationForm] 加载申请记录失败:', error);\n      this.myApplications = [];\n    } finally {\n      console.log('[LoanApplicationForm] 最终设置的应用记录数量:', this.myApplications.length);\n      this.listLoading = false;\n      m.redraw();\n    }\n  }\n\n  private renderOrderRow(appModel: LoanApplication) {\n    console.log('[LoanApplicationForm] 渲染订单行，应用模型:', appModel);\n\n    // 添加null检查防止TypeError\n    if (!appModel) {\n      console.warn('[LoanApplicationForm] 应用模型为null，跳过渲染');\n      return null;\n    }\n\n    console.log('[LoanApplicationForm] 应用模型详情:', {\n      id: appModel.id?.(),\n      hasId: typeof appModel.id,\n      hasPlatform: typeof appModel.platform,\n      hasSponsorAccount: typeof appModel.sponsorAccount,\n      hasRepaymentDate: typeof (appModel as any).repaymentDate,\n      hasStatus: typeof appModel.status,\n      hasApprovedAmount: typeof appModel.approvedAmount\n    });\n\n    const platform = appModel.platform ? appModel.platform() : null;\n    console.log('[LoanApplicationForm] 平台信息:', platform);\n\n    if (platform) {\n      console.log('[LoanApplicationForm] 平台详情:', {\n        hasName: typeof platform.name,\n        hasLogoUrl: typeof platform.logoUrl,\n        hasCurrencyImageUrl: typeof platform.currencyImageUrl,\n        name: platform.name?.(),\n        logoUrl: platform.logoUrl?.(),\n        currencyImageUrl: platform.currencyImageUrl?.()\n      });\n    }\n\n    const platformName = platform && platform.name ? platform.name() : '-';\n    const platformLogo = platform && platform.logoUrl ? platform.logoUrl() : '';\n    const currencyImg = platform && platform.currencyImageUrl ? platform.currencyImageUrl() : '';\n\n    const sponsor = appModel.sponsorAccount?.() || '-';\n    const repayment = appModel.repaymentDate?.() || '';\n    const statusText = this.statusText(appModel.status ? appModel.status() : undefined);\n    const amount = appModel.approvedAmount?.();\n\n    console.log('[LoanApplicationForm] 渲染数据:', {\n      platformName,\n      platformLogo,\n      currencyImg,\n      sponsor,\n      repayment,\n      statusText,\n      amount\n    });\n\n    return (\n      <div className=\"OrderList-row\">\n        <div className=\"col-platform\">\n          <span className=\"platform-logo-wrap\">\n            {platformLogo ? <img className=\"platform-logo\" src={platformLogo} alt={platformName} /> : <span className=\"platform-logo placeholder\"></span>}\n          </span>\n          <span className=\"platform-name\">{platformName}</span>\n        </div>\n        <div className=\"col-sponsor\">{sponsor || '-'}</div>\n        <div className=\"col-repayment\">{this.renderRepaymentCell(repayment)}</div>\n        <div className=\"col-status\">{statusText || '-'}</div>\n        <div className=\"col-amount\">\n          {typeof amount === 'number' ? (\n            <span className=\"amount\">\n              {currencyImg ? (\n                <img className=\"currency\" src={currencyImg} alt=\"currency\" />\n              ) : (\n                <span className=\"currency-text\">¥</span>\n              )}\n              <span className=\"value\">{this.formatAmount(amount)}</span>\n            </span>\n          ) : (\n            <span>-</span>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  private statusText(status?: string) {\n    switch (status) {\n      case 'approved':\n        return '已通过';\n      case 'rejected':\n        return '已拒绝';\n      case 'pending':\n      default:\n        return '审核中';\n    }\n  }\n\n  private formatAmount(num: number) {\n    return Number(num).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });\n  }\n\n  private renderRepaymentCell(dateStr?: string) {\n    const maxMonths = parseInt((app.forum.attribute('loanRepaymentMaxMonths') as any) || '6', 10);\n    const isOver = this.isOverdueLong(dateStr, maxMonths);\n    if (!dateStr) return <span>-</span>;\n    if (isOver) return <span className=\"overdue\">未还款</span>;\n    const formatted = this.formatDateYmd(dateStr);\n    return <span>{formatted ?? dateStr}</span>;\n  }\n\n  private formatDateYmd(dateStr?: string): string | null {\n    if (!dateStr) return null;\n    const d = new Date(dateStr);\n    if (isNaN(d.getTime())) return null;\n    const yyyy = d.getFullYear();\n    const mm = String(d.getMonth() + 1).padStart(2, '0');\n    const dd = String(d.getDate()).padStart(2, '0');\n    return `${yyyy}-${mm}-${dd}`;\n  }\n\n  private formatDateYmdFromDate(d: Date): string {\n    const yyyy = d.getFullYear();\n    const mm = String(d.getMonth() + 1).padStart(2, '0');\n    const dd = String(d.getDate()).padStart(2, '0');\n    return `${yyyy}-${mm}-${dd}`;\n  }\n\n  private isOverdueLong(dateStr?: string, maxMonths?: number): boolean {\n    if (!dateStr) return false;\n    const parsed = new Date(dateStr);\n    if (isNaN(parsed.getTime())) return false;\n    const now = new Date();\n    if (!maxMonths || maxMonths <= 0) return now > parsed; // fallback\n    const threshold = this.addMonths(parsed, maxMonths);\n    return now > threshold;\n  }\n\n  private addMonths(date: Date, months: number): Date {\n    const d = new Date(date.getTime());\n    const day = d.getDate();\n    d.setMonth(d.getMonth() + months);\n    if (d.getDate() < day) d.setDate(0);\n    return d;\n  }\n}\n","// js/src/forum/components/ApprovedApplicationsList.tsx\nimport Component from 'flarum/common/Component';\nimport avatar from 'flarum/common/helpers/avatar';\nimport username from 'flarum/common/helpers/username';\nimport LoanApplication from '../../common/models/LoanApplication';\nimport LoanVirtualApproval from '../../common/models/LoanVirtualApproval';\n\ntype ApprovedApplicationsListAttrs = {\n  applications: LoanApplication[];\n  virtualApprovals: LoanVirtualApproval[];\n};\n\nexport default class ApprovedApplicationsList extends Component<ApprovedApplicationsListAttrs> {\n  private scrollTimer: number | undefined;\n\n  view() {\n    const { applications = [], virtualApprovals = [] } = this.attrs as ApprovedApplicationsListAttrs;\n\n    console.log('[ApprovedApplicationsList] 渲染开始，输入数据:', {\n      applicationsCount: applications.length,\n      virtualApprovalsCount: virtualApprovals.length,\n      applications: applications,\n      virtualApprovals: virtualApprovals\n    });\n\n    // 合并真实和虚拟数据，添加null检查\n    const realApprovals = applications\n      .filter((app: LoanApplication) => {\n        const isValid = app != null && app.id() && app.approvedAmount;\n        if (!isValid) {\n          console.warn('[ApprovedApplicationsList] 过滤掉无效的真实申请:', {\n            app,\n            hasApp: app != null,\n            hasId: app?.id,\n            hasApprovedAmount: app?.approvedAmount\n          });\n        }\n        return isValid;\n      })\n      .map((app: LoanApplication, index) => {\n        console.log(`[ApprovedApplicationsList] 处理真实申请 ${index}:`, app);\n\n        const user = app.user ? app.user() : null;\n        const platform = app.platform ? app.platform() : null;\n\n        console.log(`[ApprovedApplicationsList] 真实申请 ${index} 详情:`, {\n          id: app.id?.(),\n          user: user,\n          platform: platform,\n          username: user ? username(user as any) : null,\n          avatar: user ? avatar(user as any) : null,\n          approvedAmount: app.approvedAmount?.()\n        });\n\n        const displayName = (user && (user as any).displayName && typeof (user as any).displayName === 'function')\n          ? (user as any).displayName()\n          : (user && (user as any).username && typeof (user as any).username === 'function')\n            ? (user as any).username()\n            : '';\n\n        return {\n          type: 'real',\n          id: app.id(),\n          displayName: displayName,\n          avatar: (avatar(user as any) as any) || null,\n          platformName: platform && (platform as any).name && typeof (platform as any).name === 'function' ? (platform as any).name() : '',\n          platformLogoUrl: platform && (platform as any).logoUrl && typeof (platform as any).logoUrl === 'function' ? (platform as any).logoUrl() : '',\n          currencyImageUrl: platform && (platform as any).currencyImageUrl && typeof (platform as any).currencyImageUrl === 'function' ? (platform as any).currencyImageUrl() : '',\n          amount: app.approvedAmount()\n        };\n      });\n\n    const virtualApprovalsProcessed = virtualApprovals\n      .filter((va: LoanVirtualApproval) => {\n        const isValid = va != null && va.id() && va.amount;\n        return isValid;\n      })\n      .map((va: LoanVirtualApproval, index) => {\n\n        const platform = va.platform ? va.platform() : null;\n        const result = {\n          type: 'virtual',\n          id: va.id(),\n          displayName: va.fakeUsername ? va.fakeUsername() : '',\n          avatar: va.fakeAvatarUrl ? <img src={va.fakeAvatarUrl()} className=\"Avatar\" /> : null,\n          platformName: platform && (platform as any).name && typeof (platform as any).name === 'function' ? (platform as any).name() : '',\n          platformLogoUrl: platform && (platform as any).logoUrl && typeof (platform as any).logoUrl === 'function' ? (platform as any).logoUrl() : '',\n          currencyImageUrl: platform && (platform as any).currencyImageUrl && typeof (platform as any).currencyImageUrl === 'function' ? (platform as any).currencyImageUrl() : '',\n          amount: va.amount()\n        };\n\n        return result;\n      });\n\n    const allApprovals = [...realApprovals, ...virtualApprovalsProcessed];\n\n    console.log('[ApprovedApplicationsList] 合并后的数据:', {\n      realCount: realApprovals.length,\n      virtualCount: virtualApprovalsProcessed.length,\n      totalCount: allApprovals.length,\n      allApprovals: allApprovals\n    });\n\n    // 随机排序\n    allApprovals.sort(() => Math.random() - 0.5);\n\n    return (\n      <div className=\"ApprovedApplicationsList Leaderboard\">\n        <div className=\"Leaderboard-header\">\n          <span className=\"col-user\">用户</span>\n          <span className=\"col-platform\">贷款平台</span>\n          <span className=\"col-amount\">获批额度</span>\n        </div>\n        <div className=\"Leaderboard-body\" oncreate={this.startAutoScroll.bind(this)} onremove={this.stopAutoScroll.bind(this)}>\n          <div className=\"Leaderboard-scroll\">\n            {allApprovals.map((item, index) => this.renderRow(item, index))}\n            {allApprovals.map((item, index) => this.renderRow(item, index, true))}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  renderRow(approval: any, index: number, clone: boolean = false) {\n    const userName = typeof approval.displayName === 'string' ? approval.displayName : '';\n    const avatarNode = approval.avatar ? approval.avatar : <span className=\"Avatar Avatar--placeholder\"></span>;\n    return (\n      <div className={`LeaderRow${clone ? ' clone' : ''}`} key={`${approval.id}-${clone ? 'c' : 'o'}`}>\n        <div className=\"col-user\">\n          {avatarNode}\n          <span className=\"nickname\">{userName || '隐藏'}</span>\n        </div>\n        <div className=\"col-platform\">\n          {approval.platformLogoUrl ? (\n            <span className=\"platform-badge\"><img src={approval.platformLogoUrl} alt=\"\" /></span>\n          ) : (\n            <span className=\"platform-badge platform-badge--placeholder\" />\n          )}\n          <span className=\"platform-name\">{approval.platformName || '-'}</span>\n        </div>\n        <div className=\"col-amount\">\n          {approval.currencyImageUrl ? (\n            <img className=\"coin\" src={approval.currencyImageUrl} alt=\"coin\" />\n          ) : (\n            <span className=\"coin\">¥</span>\n          )}\n          <span className=\"value\">{this.formatAmount(approval.amount)}</span>\n        </div>\n      </div>\n    );\n  }\n\n  startAutoScroll(vnode: any) {\n    const container: HTMLElement = vnode.dom as HTMLElement;\n    const inner = container.querySelector('.Leaderboard-scroll') as HTMLElement;\n    if (!container || !inner) return;\n\n    let offset = 0;\n    const step = () => {\n      offset += 0.5; // speed\n      if (offset >= inner.scrollHeight / 2) {\n        offset = 0;\n      }\n      inner.style.transform = `translateY(-${offset}px)`;\n      this.scrollTimer = window.requestAnimationFrame(step) as any;\n    };\n    this.scrollTimer = window.requestAnimationFrame(step) as any;\n  }\n\n  stopAutoScroll() {\n    if (this.scrollTimer) cancelAnimationFrame(this.scrollTimer);\n  }\n\n  formatAmount(num: number, fixed?: number) {\n    // 展示为整数，去除小数点\n    const integer = Math.trunc(Number(num));\n    return integer.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });\n  }\n}\n","import Component from 'flarum/common/Component';\nimport Button from 'flarum/common/components/Button';\nimport app from 'flarum/forum/app';\nimport LoanApplicationForm from './LoanApplicationForm';\nimport ApprovedApplicationsList from './ApprovedApplicationsList';\nimport m, { Vnode } from 'mithril';\nimport LoanPlatform from '../../common/models/LoanPlatform';\nimport LoanApplication from '../../common/models/LoanApplication';\nimport LoanVirtualApproval from '../../common/models/LoanVirtualApproval';\n\nexport default class LoanApplicationPage extends Component {\n  private loading: boolean = false;\n  private platforms: LoanPlatform[] = [];\n  private approvedApplications: LoanApplication[] = [];\n  private virtualApprovals: LoanVirtualApproval[] = [];\n\n  oninit(vnode: Vnode) {\n    super.oninit(vnode);\n\n    this.loading = true;\n    this.platforms = [];\n    this.approvedApplications = [];\n    this.virtualApprovals = [];\n\n    this.loadData();\n  }\n\n  async loadData(): Promise<void> {\n\n    // 使用 Promise.allSettled 来处理各个请求，即使某个失败也不影响其他\n    const results = await Promise.allSettled([\n      app.store.find('loan-platforms') as any,\n      app.store.find('loan-applications', { filter: { approved: '1' }, include: 'user,platform' } as any) as any,\n      app.store.find('loan-virtual-approvals', { include: 'platform' }) as any\n    ]);\n\n    // 处理平台数据\n    if (results[0].status === 'fulfilled') {\n      const platforms = results[0].value;\n      this.platforms = Array.isArray(platforms) ? platforms.filter(p => {\n        const isValid = p != null;\n        if (!isValid) console.warn('[LoanApplicationPage] 发现null平台:', p);\n        return isValid;\n      }) : [];\n\n      // 详细检查每个平台\n      this.platforms.forEach((platform, index) => {\n        console.log(`[LoanApplicationPage] 平台 ${index}:`, {\n          id: platform.id?.(),\n          name: platform.name?.(),\n          logoUrl: platform.logoUrl?.(),\n          sponsorLinkUrl: platform.sponsorLinkUrl?.(),\n          currencyImageUrl: platform.currencyImageUrl?.()\n        });\n      });\n    } else {\n      console.error('[LoanApplicationPage] 加载平台失败:', results[0].reason);\n      this.platforms = [];\n    }\n\n    // 处理已批准申请数据\n    if (results[1].status === 'fulfilled') {\n      const approvedApps = results[1].value;\n      this.approvedApplications = Array.isArray(approvedApps) ? approvedApps.filter(app => {\n        const isValid = app != null;\n        if (!isValid) console.warn('[LoanApplicationPage] 发现null已批准申请:', app);\n        return isValid;\n      }) : [];\n      console.log('[LoanApplicationPage] 已批准申请加载成功，数量:', this.approvedApplications.length);\n    } else {\n      console.error('[LoanApplicationPage] 加载已批准申请失败:', results[1].reason);\n      this.approvedApplications = [];\n    }\n\n    // 处理虚拟审批数据\n    if (results[2].status === 'fulfilled') {\n      const virtualApprovals = results[2].value;\n      this.virtualApprovals = Array.isArray(virtualApprovals) ? virtualApprovals.filter(v => {\n        const isValid = v != null;\n        if (!isValid) console.warn('[LoanApplicationPage] 发现null虚拟批准:', v);\n        return isValid;\n      }) : [];\n    } else {\n      this.virtualApprovals = [];\n    }\n\n    this.loading = false;\n    m.redraw();\n  }\n  oncreate() {\n    document.body.classList.add('loan-standalone');\n  }\n\n  onremove() {\n    document.body.classList.remove('loan-standalone');\n  }\n  private goBack() {\n    if (window.history.length > 1) {\n      window.history.back();\n    } else {\n      const home = (app.forum.attribute('baseUrl') as string) || '/';\n      window.location.href = home;\n    }\n  }\n  view() {\n    if (this.loading) return <div className=\"LoanPage\">加载中...</div>;\n\n    return (\n      <div className=\"LoanPage\">\n        <div className=\"LoanBackButton\">\n          <Button className=\"Button Button--link\" icon=\"fas fa-arrow-left\" onclick={this.goBack.bind(this)}>\n            返回\n          </Button>\n        </div>\n        <h2>贷款申请</h2>\n        <LoanApplicationForm\n          platforms={this.platforms}\n          onSubmit={this.submitApplication.bind(this)}\n        />\n\n        <ApprovedApplicationsList\n          applications={this.approvedApplications}\n          virtualApprovals={this.virtualApprovals}\n        />\n      </div>\n    );\n  }\n\n  async submitApplication(payload: { platform_id: string; sponsor_account?: string; repayment_date?: string }): Promise<void> {\n    await app.request({\n      method: 'POST',\n      url: app.forum.attribute('apiUrl') + '/loan-applications',\n      body: { data: { attributes: payload } }\n    });\n\n    app.alerts.show({ type: 'success' }, '提交成功，等待审核');\n  }\n}\n","import Model from 'flarum/common/Model';\n\nexport default class LoanPlatform extends Model {\n  name = Model.attribute<string>('name');\n  logoUrl = Model.attribute<string>('logoUrl');\n  sponsorLinkUrl = Model.attribute<string>('sponsorLinkUrl');\n  currencyImageUrl = Model.attribute<string>('currencyImageUrl');\n  sortOrder = Model.attribute<number>('sortOrder');\n}\n","import Model from 'flarum/common/Model';\nimport User from 'flarum/common/models/User';\nimport LoanPlatform from './LoanPlatform';\n\nexport default class LoanApplication extends Model {\n  sponsorAccount = Model.attribute<string>('sponsorAccount');\n  repaymentDate = Model.attribute<string>('repaymentDate');\n  status = Model.attribute<string>('status');\n  approvedAmount = Model.attribute<number>('approvedAmount');\n  createdAt = Model.attribute<Date>('createdAt');\n  reviewedAt = Model.attribute<Date>('reviewedAt');\n\n  user = Model.hasOne<User>('user');\n  platform = Model.hasOne<LoanPlatform>('platform');\n}\n","import Model from 'flarum/common/Model';\nimport LoanPlatform from './LoanPlatform';\n\nexport default class LoanVirtualApproval extends Model {\n  fakeUsername = Model.attribute<string>('fakeUsername');\n  fakeAvatarUrl = Model.attribute<string>('fakeAvatarUrl');\n  amount = Model.attribute<number>('amount');\n  platform = Model.hasOne<LoanPlatform>('platform');\n}\n","import app from 'flarum/forum/app';\nimport LoanApplicationPage from './components/LoanApplicationPage';\nimport LoanPlatform from '../common/models/LoanPlatform';\nimport LoanApplication from '../common/models/LoanApplication';\nimport LoanVirtualApproval from '../common/models/LoanVirtualApproval';\n\napp.initializers.add('wusong8899-loan', () => {\n  app.routes['wusong8899.loan'] = { path: '/loan', component: LoanApplicationPage } as any;\n  app.store.models['loan-platforms'] = LoanPlatform;\n  app.store.models['loan-applications'] = LoanApplication;\n  app.store.models['loan-virtual-approvals'] = LoanVirtualApproval;\n});\n"],"names":["PlatformSelect","Component","m","vnode","platforms","value","list","p","selected","e","index","val","PLAY_ICON_PATH","LoanApplicationForm","Stream","selectedPlatform","maxMonthsCfg","app","todayStr","maxDateStr","Button","appModel","row","platform","url","result","filteredApps","applicationModel","isValid","currentUser","currentUserId","mineOnly","userModel","error","platformName","platformLogo","currencyImg","sponsor","repayment","statusText","amount","status","num","dateStr","maxMonths","isOver","formatted","d","yyyy","mm","dd","parsed","now","threshold","date","months","day","ApprovedApplicationsList","applications","virtualApprovals","realApprovals","user","username","avatar","displayName","virtualApprovalsProcessed","va","allApprovals","item","approval","clone","userName","avatarNode","container","inner","offset","step","fixed","LoanApplicationPage","results","approvedApps","v","home","payload","LoanPlatform","Model","LoanApplication","LoanVirtualApproval"],"mappings":"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"}