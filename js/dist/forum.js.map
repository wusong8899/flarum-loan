{"version":3,"file":"forum.js","sources":["../src/forum/components/LoanApplicationForm.tsx","../src/forum/components/ApprovedApplicationsList.tsx","../src/forum/components/LoanApplicationPage.tsx","../src/forum/index.ts"],"sourcesContent":["// js/src/forum/components/LoanApplicationForm.tsx\nimport Component from 'flarum/common/Component';\nimport Button from 'flarum/common/components/Button';\nimport Select from 'flarum/common/components/Select';\nimport Stream from 'flarum/common/utils/Stream';\nimport {Vnode} from 'mithril';\nimport LoanPlatform from '../../common/models/LoanPlatform';\n\ntype LoanApplicationFormAttrs = {\n  platforms: LoanPlatform[];\n  onSubmit: (payload: { platform_id: string; message: string }) => Promise<void> | void;\n};\n\nexport default class LoanApplicationForm extends Component<LoanApplicationFormAttrs> {\n  private platformId: any;\n  private message: any;\n  private loading: boolean = false;\n\n  oninit(vnode: Vnode) {\n    super.oninit(vnode);\n\n    this.platformId = Stream('');\n    this.message = Stream('');\n    this.loading = false;\n  }\n\n  view() {\n    const platforms = (this.attrs as LoanApplicationFormAttrs).platforms || [];\n\n    return (\n      <div className=\"LoanApplicationForm\">\n        <div className=\"Form-group\">\n          <label>选择平台</label>\n          <Select\n            value={this.platformId()}\n            onchange={this.platformId}\n            options={platforms.reduce((options: Record<string, any>, platform: LoanPlatform) => {\n              options[String(platform.id())] = (\n                <div className=\"PlatformOption\">\n                  <img src={platform.logoUrl()} alt={platform.name()} />\n                  <span>{platform.name()}</span>\n                </div>\n              );\n              return options;\n            }, {})}\n          />\n        </div>\n\n        <div className=\"Form-group\">\n          <label>留言</label>\n          <textarea\n            className=\"FormControl\"\n            value={this.message()}\n            oninput={(e: InputEvent) => this.message((e.target as HTMLTextAreaElement).value)}\n            placeholder=\"请输入您的留言...\"\n            rows=\"4\"\n          />\n        </div>\n\n        <Button\n          className=\"Button Button--primary\"\n          loading={this.loading}\n          disabled={!this.platformId() || !this.message()}\n          onclick={this.submit.bind(this)}\n        >\n          提交申请\n        </Button>\n      </div>\n    );\n  }\n\n  async submit(): Promise<void> {\n    if (this.loading) return;\n\n    this.loading = true;\n\n    try {\n      await (this.attrs as LoanApplicationFormAttrs).onSubmit({\n        platform_id: this.platformId(),\n        message: this.message()\n      });\n\n      // 重置表单\n      this.platformId('');\n      this.message('');\n    } finally {\n      this.loading = false;\n    }\n  }\n}\n","// js/src/forum/components/ApprovedApplicationsList.tsx\nimport Component from 'flarum/common/Component';\nimport avatar from 'flarum/common/helpers/avatar';\nimport username from 'flarum/common/helpers/username';\nimport LoanApplication from '../../common/models/LoanApplication';\nimport LoanVirtualApproval from '../../common/models/LoanVirtualApproval';\n\ntype ApprovedApplicationsListAttrs = {\n  applications: LoanApplication[];\n  virtualApprovals: LoanVirtualApproval[];\n};\n\nexport default class ApprovedApplicationsList extends Component<ApprovedApplicationsListAttrs> {\n  view() {\n    const { applications = [], virtualApprovals = [] } = this.attrs as ApprovedApplicationsListAttrs;\n\n    // 合并真实和虚拟数据\n    const allApprovals = [\n      ...applications.map((app: LoanApplication) => ({\n        type: 'real',\n        id: app.id(),\n        username: username((app.user() || null) as any),\n        avatar: avatar((app.user() || null) as any),\n        platform: app.platform() as any,\n        amount: app.approvedAmount()\n      })),\n      ...virtualApprovals.map((va: LoanVirtualApproval) => ({\n        type: 'virtual',\n        id: va.id(),\n        username: va.fakeUsername(),\n        avatar: <img src={va.fakeAvatarUrl()} className=\"Avatar\" />,\n        platform: va.platform(),\n        amount: va.amount()\n      }))\n    ];\n\n    // 随机排序\n    allApprovals.sort(() => Math.random() - 0.5);\n\n    return (\n      <div className=\"ApprovedApplicationsList\">\n        <h3>申请通过列表</h3>\n        <div className=\"ApprovalCards\">\n          {allApprovals.map(approval => (\n            <div className=\"ApprovalCard\" key={approval.id}>\n              <div className=\"ApprovalCard-user\">\n                {approval.avatar}\n                <span className=\"username\">{approval.username}</span>\n              </div>\n\n              <div className=\"ApprovalCard-platform\">\n                <img\n                  src={(approval.platform as any).logoUrl?.()}\n                  alt={(approval.platform as any).name?.()}\n                  className=\"platform-logo\"\n                />\n                <span className=\"platform-name\">{(approval.platform as any).name?.()}</span>\n              </div>\n\n              <div className=\"ApprovalCard-amount\">\n                <span className=\"amount-label\">获批额度</span>\n                <span className=\"amount-value\">¥{approval.amount}</span>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n}\n","import Component from 'flarum/common/Component';\nimport app from 'flarum/forum/app';\nimport Button from 'flarum/common/components/Button';\nimport Select from 'flarum/common/components/Select';\nimport Stream from 'flarum/common/utils/Stream';\nimport LoanApplicationForm from './LoanApplicationForm';\nimport ApprovedApplicationsList from './ApprovedApplicationsList';\nimport m,{Vnode} from 'mithril';\nimport LoanPlatform from '../../common/models/LoanPlatform';\nimport LoanApplication from '../../common/models/LoanApplication';\nimport LoanVirtualApproval from '../../common/models/LoanVirtualApproval';\n\nexport default class LoanApplicationPage extends Component {\n  private loading: boolean = false;\n  private platforms: LoanPlatform[] = [];\n  private approvedApplications: LoanApplication[] = [];\n  private virtualApprovals: LoanVirtualApproval[] = [];\n\n  oninit(vnode: Vnode) {\n    super.oninit(vnode);\n\n    this.loading = true;\n    this.platforms = [];\n    this.approvedApplications = [];\n    this.virtualApprovals = [];\n\n    this.loadData();\n  }\n\n  async loadData(): Promise<void> {\n    try {\n      this.platforms = await app.store.find('loan-platforms') as any;\n      this.approvedApplications = await app.store.find('loan-applications', { filter: { approved: '1' } } as any) as any;\n      this.virtualApprovals = await app.store.find('loan-virtual-approvals') as any;\n    } finally {\n      this.loading = false;\n      m.redraw();\n    }\n  }\n\n  view() {\n    if (this.loading) return <div className=\"LoanPage\">加载中...</div>;\n\n    return (\n      <div className=\"LoanPage\">\n        <h2>贷款申请</h2>\n        <LoanApplicationForm\n          platforms={this.platforms}\n          onSubmit={this.submitApplication.bind(this)}\n        />\n\n        <ApprovedApplicationsList\n          applications={this.approvedApplications}\n          virtualApprovals={this.virtualApprovals}\n        />\n      </div>\n    );\n  }\n\n  async submitApplication(payload: { platform_id: string; message: string }): Promise<void> {\n    await app.request({\n      method: 'POST',\n      url: app.forum.attribute('apiUrl') + '/loan-applications',\n      body: { data: { attributes: payload } }\n    });\n\n    app.alerts.show({ type: 'success' }, '提交成功，等待审核');\n  }\n}\n","import app from 'flarum/forum/app';\nimport LoanApplicationPage from './components/LoanApplicationPage';\n\napp.initializers.add('wusong8899-loan', () => {\n  app.routes['wusong8899.loan'] = { path: '/loan', component: LoanApplicationPage } as any;\n});\n"],"names":["LoanApplicationForm","Component","vnode","Stream","platforms","Select","options","platform","e","Button","ApprovedApplicationsList","applications","virtualApprovals","allApprovals","app","username","avatar","va","approval","LoanApplicationPage","m","payload"],"mappings":"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"}