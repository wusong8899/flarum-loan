(function(s,c,o,i,u,r,t){"use strict";const n={isValidUrl(e){try{const a=new URL(e);return a.protocol==="http:"||a.protocol==="https:"}catch{return!1}},isImageUrl(e){if(!this.isValidUrl(e))return!1;const a=["jpg","jpeg","png","gif","svg","webp"],f=new URL(e).pathname.toLowerCase().split(".").pop()||"";return a.includes(f)},checkImageAccessible(e){return new Promise(a=>{const l=new Image;l.onload=()=>a(!0),l.onerror=()=>a(!1),l.src=e})}};class h extends u{oninit(a){super.oninit(a);const l=this.attrs.platform;this.name=r(l?l.name():""),this.logoUrl=r(l?l.logoUrl():""),this.previewError=r(!1)}className(){return"PlatformEditModal Modal--small"}title(){return this.attrs.platform?"编辑平台":"新增平台"}content(){return t("div",{className:"Modal-body"},t("div",{className:"Form-group"},t("label",null,"平台名称"),t("input",{className:"FormControl",value:this.name(),oninput:a=>this.name(a.target.value),placeholder:"例如：支付宝"})),t("div",{className:"Form-group"},t("label",null,"Logo图片链接"),t("input",{className:"FormControl",type:"url",value:this.logoUrl(),oninput:a=>this.handleUrlChange(a.target.value),placeholder:"https://example.com/logo.png"}),t("div",{className:"helpText"},"请输入图片的完整URL地址（支持jpg、png、gif、svg格式）")),this.logoUrl()&&t("div",{className:"Form-group"},t("label",null,"图片预览"),t("div",{className:"logo-preview"},this.previewError()?t("div",{className:"preview-error"},t("i",{className:"fas fa-exclamation-triangle"}),t("p",null,"图片加载失败，请检查链接是否正确")):t("img",{src:this.logoUrl(),alt:"Logo预览",onload:()=>{this.previewError(!1),t.redraw()},onerror:()=>{this.previewError(!0),t.redraw()}}))),t("div",{className:"Form-group"},t(i,{className:"Button Button--primary",loading:this.loading,disabled:!this.name()||!this.logoUrl()||this.previewError(),onclick:this.save.bind(this)},"保存")))}handleUrlChange(a){this.logoUrl(a),this.previewError(!1),a&&!this.isValidUrl(a)&&this.previewError(!0)}isValidUrl(a){return n.isValidUrl(a)&&n.isImageUrl(a)}async save(){if(!this.isValidUrl(this.logoUrl())){s.alerts.show({type:"error"},"请输入有效的图片链接");return}this.loading=!0;try{await(this.attrs.platform||s.store.createRecord("loan-platforms")).save({name:this.name(),logoUrl:this.logoUrl()}),this.attrs.onSave(),this.hide(),s.alerts.show({type:"success"},"保存成功")}finally{this.loading=!1}}}class d extends o{constructor(){super(...arguments),this.loading=!1,this.platforms=[]}oninit(a){super.oninit(a),this.loading=!0,this.platforms=[],this.loadPlatforms()}async loadPlatforms(){try{this.platforms=await s.store.find("loan-platforms")}finally{this.loading=!1,t.redraw()}}view(){return t("div",{className:"PlatformManager"},t("div",{className:"PlatformManager-header"},t("h3",null,"贷款平台管理"),t(i,{className:"Button Button--primary",onclick:()=>this.editPlatform()},"新增平台")),this.loading?t("div",null,"加载中..."):t("table",{className:"PlatformTable"},t("thead",null,t("tr",null,t("th",null,"Logo"),t("th",null,"平台名称"),t("th",null,"操作"))),t("tbody",null,this.platforms.map(a=>t("tr",{key:a.id()},t("td",null,t("img",{src:a.logoUrl(),style:"max-width: 50px;"})),t("td",null,a.name()),t("td",null,t(i,{className:"Button Button--link",onclick:()=>this.editPlatform(a)},"编辑"),t(i,{className:"Button Button--link",onclick:()=>this.deletePlatform(a)},"删除"),t(i,{className:"Button Button--link",onclick:()=>this.generateVirtual(a)},"生成虚拟数据")))))))}editPlatform(a=null){s.modal.show(h,{platform:a,onSave:()=>this.loadPlatforms()})}async deletePlatform(a){confirm("确定删除该平台吗？")&&(await a.delete(),this.loadPlatforms())}async generateVirtual(a){const l=prompt("请输入要生成的虚拟数据数量","10");l&&(await s.request({method:"POST",url:s.forum.attribute("apiUrl")+"/loan-applications/generate-virtual",body:{data:{attributes:{platform_id:a.id(),count:parseInt(l)}}}}),s.alerts.show({type:"success"},`成功生成${l}条虚拟数据`))}}class g extends o{constructor(){super(...arguments),this.loading=!1,this.applications=[]}oninit(a){super.oninit(a),this.loading=!0,this.applications=[],this.load()}async load(){try{this.applications=await s.store.find("loan-applications")}finally{this.loading=!1,t.redraw()}}view(){return t("div",{className:"ApplicationsManager"},t("div",{className:"ApplicationsManager-header"},t("h3",null,"贷款申请管理"),t(i,{className:"Button",onclick:()=>this.load()},"刷新")),this.loading?t("div",null,"加载中..."):t("table",{className:"ApplicationTable"},t("thead",null,t("tr",null,t("th",null,"用户"),t("th",null,"平台"),t("th",null,"留言"),t("th",null,"状态"),t("th",null,"批准额度"),t("th",null,"操作"))),t("tbody",null,this.applications.map(a=>t("tr",{key:a.id()},t("td",null,a.user()&&a.user().displayName?a.user().displayName():"-"),t("td",null,a.platform()&&a.platform().name?a.platform().name():"-"),t("td",null,a.message()),t("td",null,a.status()),t("td",null,a.approvedAmount()||"-"),t("td",null,t(i,{className:"Button Button--link",onclick:()=>this.review(a,"approved")},"通过"),t(i,{className:"Button Button--link",onclick:()=>this.review(a,"rejected")},"拒绝"),t(i,{className:"Button Button--link",onclick:()=>this.remove(a)},"删除")))))))}async review(a,l){await s.request({method:"PATCH",url:`${s.forum.attribute("apiUrl")}/loan-applications/${a.id()}`,body:{data:{attributes:{status:l}}}}),await this.load()}async remove(a){confirm("确定删除该申请吗？")&&(await a.delete(),await this.load())}}class p extends c{constructor(){super(...arguments),this.activeTab="platforms"}oninit(a){super.oninit(a),this.activeTab="platforms"}content(){return t("div",{className:"LoanSettingsPage"},t("div",{className:"LoanSettingsPage-tabs"},t("button",{className:this.activeTab==="platforms"?"active":"",onclick:()=>{this.activeTab="platforms",t.redraw()}},"平台管理"),t("button",{className:this.activeTab==="applications"?"active":"",onclick:()=>{this.activeTab="applications",t.redraw()}},"申请管理")),t("div",{className:"LoanSettingsPage-content"},this.activeTab==="platforms"&&t(d,null),this.activeTab==="applications"&&t(g,null)))}}s.initializers.add("wusong8899-loan",()=>{s.extensionData.for("wusong8899-loan").registerPage(p)})})(flarum.core.compat["admin/app"],flarum.core.compat["admin/components/ExtensionPage"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/utils/Stream"],m);
//# sourceMappingURL=admin.js.map

module.exports={};