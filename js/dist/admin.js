(function(r,d,u,n,g,o,t,e){"use strict";const h={isValidUrl(l){try{const a=new URL(l);return a.protocol==="http:"||a.protocol==="https:"}catch{return!1}},isImageUrl(l){if(!this.isValidUrl(l))return!1;const a=["jpg","jpeg","png","gif","svg","webp"],i=new URL(l).pathname.toLowerCase().split(".").pop()||"";return a.includes(i)},checkImageAccessible(l){return new Promise(a=>{const s=new Image;s.onload=()=>a(!0),s.onerror=()=>a(!1),s.src=l})}};class f extends g{oninit(a){super.oninit(a);const s=this.attrs.platform;this.name=o(s?s.name():""),this.logoUrl=o(s?s.logoUrl():""),this.linkUrl=o(s?s.sponsorLinkUrl():""),this.currencyImageUrl=o(s?s.currencyImageUrl?.():""),this.previewError=o(!1)}className(){return"PlatformEditModal Modal--small"}title(){return this.attrs.platform?"编辑平台":"新增平台"}content(){return t("div",{className:"Modal-body"},t("div",{className:"Form-group"},t("label",null,"平台名称"),t("input",{className:"FormControl",value:this.name(),oninput:a=>this.name(a.target.value),placeholder:"例如：支付宝"})),t("div",{className:"Form-group"},t("label",null,"Logo图片链接"),t("input",{className:"FormControl",type:"url",value:this.logoUrl(),oninput:a=>this.handleUrlChange(a.target.value),placeholder:"https://example.com/logo.png"}),t("div",{className:"helpText"},"请输入图片的完整URL地址（支持jpg、png、gif、svg格式）")),t("div",{className:"Form-group"},t("label",null,"赞助平台链接（可选）"),t("input",{className:"FormControl",type:"url",value:this.linkUrl(),oninput:a=>this.linkUrl(a.target.value),placeholder:"https://example.com/guide"})),t("div",{className:"Form-group"},t("label",null,"货币图片链接（可选）"),t("input",{className:"FormControl",type:"url",value:this.currencyImageUrl(),oninput:a=>this.currencyImageUrl(a.target.value),placeholder:"https://example.com/currency.png"}),t("div",{className:"helpText"},"用于在前台显示批准额度前的货币图标")),this.logoUrl()&&t("div",{className:"Form-group"},t("label",null,"图片预览"),t("div",{className:"logo-preview"},this.previewError()?t("div",{className:"preview-error"},t("i",{className:"fas fa-exclamation-triangle"}),t("p",null,"图片加载失败，请检查链接是否正确")):t("img",{src:this.logoUrl(),alt:"Logo预览",onload:()=>{this.previewError(!1),t.redraw()},onerror:()=>{this.previewError(!0),t.redraw()}}))),t("div",{className:"Form-group"},t(n,{className:"Button Button--primary",loading:this.loading,disabled:!this.name()||!this.logoUrl()||this.previewError(),onclick:this.save.bind(this)},"保存")))}handleUrlChange(a){this.logoUrl(a),this.previewError(!1),a&&!this.isValidUrl(a)&&this.previewError(!0)}isValidUrl(a){return h.isValidUrl(a)&&h.isImageUrl(a)}async save(){if(!this.isValidUrl(this.logoUrl())){r.alerts.show({type:"error"},"请输入有效的图片链接");return}this.loading=!0;try{await(this.attrs.platform||r.store.createRecord("loan-platforms")).save({name:this.name(),logoUrl:this.logoUrl(),sponsorLinkUrl:this.linkUrl(),currencyImageUrl:this.currencyImageUrl()}),this.attrs.onSave(),this.hide(),r.alerts.show({type:"success"},"保存成功")}finally{this.loading=!1}}}class v extends u{constructor(){super(...arguments),this.loading=!1,this.platforms=[]}oninit(a){super.oninit(a),this.loading=!0,this.platforms=[],this.loadPlatforms()}async loadPlatforms(){try{this.platforms=await r.store.find("loan-platforms")}finally{this.loading=!1,t.redraw()}}view(){return t("div",{className:"PlatformManager"},t("div",{className:"PlatformManager-header"},t("h3",null,"贷款平台管理"),t(n,{className:"Button Button--primary",onclick:()=>this.editPlatform()},"新增平台")),this.loading?t("div",null,"加载中..."):t("table",{className:"PlatformTable"},t("thead",null,t("tr",null,t("th",null,"Logo"),t("th",null,"平台名称"),t("th",null,"操作"))),t("tbody",null,this.platforms.map(a=>t("tr",{key:a.id()},t("td",null,t("img",{src:a.logoUrl(),style:"max-width: 50px;"})),t("td",null,a.name()),t("td",null,t(n,{className:"Button Button--link",onclick:()=>this.editPlatform(a)},"编辑"),t(n,{className:"Button Button--link",onclick:()=>this.deletePlatform(a)},"删除"),a.sponsorLinkUrl?.()&&t(n,{className:"Button Button--link",onclick:()=>window.open(a.sponsorLinkUrl(),"_blank")},"打开赞助链接"),t(n,{className:"Button Button--link",onclick:()=>this.generateVirtual(a)},"生成虚拟数据")))))))}editPlatform(a=null){r.modal.show(f,{platform:a,onSave:()=>this.loadPlatforms()})}async deletePlatform(a){confirm("确定删除该平台吗？")&&(await a.delete(),this.loadPlatforms())}async generateVirtual(a){const s=prompt("请输入要生成的虚拟数据数量","10");s&&(await r.request({method:"POST",url:r.forum.attribute("apiUrl")+"/loan-applications/generate-virtual",body:{data:{attributes:{platform_id:a.id(),count:parseInt(s)}}}}),r.alerts.show({type:"success"},`成功生成${s}条虚拟数据`))}}class w extends u{constructor(){super(...arguments),this.loading=!1,this.applications=[]}oninit(a){super.oninit(a),this.loading=!0,this.applications=[],this.load()}async load(){try{this.applications=await r.store.find("loan-applications",{include:"user,platform"})}finally{this.loading=!1,t.redraw()}}view(){return t("div",{className:"ApplicationsManager"},t("div",{className:"ApplicationsManager-header"},t("h3",null,"贷款申请管理"),t(n,{className:"Button",onclick:()=>this.load()},"刷新")),this.loading?t("div",null,"加载中..."):t("table",{className:"ApplicationTable"},t("thead",null,t("tr",null,t("th",null,"用户"),t("th",null,"平台"),t("th",null,"赞助账号"),t("th",null,"申请账号"),t("th",null,"状态"),t("th",null,"批准额度"),t("th",null,"操作"))),t("tbody",null,this.applications.map(a=>t("tr",{key:a.id()},t("td",null,a.user()&&a.user().displayName?a.user().displayName():"-"),t("td",null,a.platform()&&a.platform().name?a.platform().name():"-"),t("td",null,a.sponsorAccount?.()||"-"),t("td",null,a.applicantAccount?.()||"-"),t("td",null,a.status()),t("td",null,a.approvedAmount()||"-"),t("td",null,t(n,{className:"Button Button--link",onclick:()=>this.review(a,"approved")},"通过"),t(n,{className:"Button Button--link",onclick:()=>this.review(a,"rejected")},"拒绝"),t(n,{className:"Button Button--link",onclick:()=>this.openSponsorLink(a)},"赞助链接"),t(n,{className:"Button Button--link",onclick:()=>this.remove(a)},"删除")))))))}async review(a,s){const i={status:s};if(s==="approved"){const N=a.approvedAmount?.()?String(a.approvedAmount()):"",p=prompt("请输入批准额度（整数）",N);if(p===null)return;const c=parseInt(p,10);if(isNaN(c)||c<0){alert("请输入有效的非负整数");return}i.approved_amount=c}else i.approved_amount=null;await r.request({method:"PATCH",url:`${r.forum.attribute("apiUrl")}/loan-applications/${a.id()}`,body:{data:{attributes:i}}}),await this.load()}async remove(a){confirm("确定删除该申请吗？")&&(await a.delete(),await this.load())}openSponsorLink(a){const s=a.platform(),i=s&&s.sponsorLinkUrl?s.sponsorLinkUrl():null;i?window.open(i,"_blank"):r.alerts.show({type:"warning"},"该平台未配置赞助平台链接")}}class U extends d{constructor(){super(...arguments),this.activeTab="platforms"}oninit(a){super.oninit(a),this.activeTab="platforms"}content(){return t("div",{className:"LoanSettingsPage"},t("div",{className:"LoanSettingsPage-tabs"},t("button",{className:this.activeTab==="platforms"?"active":"",onclick:()=>{this.activeTab="platforms",t.redraw()}},"平台管理"),t("button",{className:this.activeTab==="applications"?"active":"",onclick:()=>{this.activeTab="applications",t.redraw()}},"申请管理")),t("div",{className:"LoanSettingsPage-content"},this.activeTab==="platforms"&&t(v,null),this.activeTab==="applications"&&t(w,null),t("div",{className:"LoanSettingsPage-danger"},t("h4",null,"危险操作"),t("button",{className:"Button Button--danger",onclick:this.clearAll.bind(this)},"一键清空申请/审批"))))}async clearAll(){if(confirm("确定要清空所有申请与虚拟审批数据吗？此操作不可撤销。"))try{await r.request({method:"DELETE",url:r.forum.attribute("apiUrl")+"/loan-clear"}),r.alerts.show({type:"success"},"已清空申请与虚拟审批数据")}catch(a){r.alerts.show({type:"error"},"清空失败 "+a)}}}class b extends e{constructor(){super(...arguments),this.name=e.attribute("name"),this.logoUrl=e.attribute("logoUrl"),this.sponsorLinkUrl=e.attribute("sponsorLinkUrl"),this.currencyImageUrl=e.attribute("currencyImageUrl"),this.sortOrder=e.attribute("sortOrder")}}class y extends e{constructor(){super(...arguments),this.sponsorAccount=e.attribute("sponsorAccount"),this.applicantAccount=e.attribute("applicantAccount"),this.status=e.attribute("status"),this.approvedAmount=e.attribute("approvedAmount"),this.createdAt=e.attribute("createdAt"),this.reviewedAt=e.attribute("reviewedAt"),this.user=e.hasOne("user"),this.platform=e.hasOne("platform")}}class k extends e{constructor(){super(...arguments),this.fakeUsername=e.attribute("fakeUsername"),this.fakeAvatarUrl=e.attribute("fakeAvatarUrl"),this.amount=e.attribute("amount"),this.platform=e.hasOne("platform")}}r.initializers.add("wusong8899-loan",()=>{r.extensionData.for("wusong8899-loan").registerPage(U),r.store.models["loan-platforms"]=b,r.store.models["loan-applications"]=y,r.store.models["loan-virtual-approvals"]=k})})(flarum.core.compat["admin/app"],flarum.core.compat["admin/components/ExtensionPage"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/utils/Stream"],m,flarum.core.compat["common/Model"]);
//# sourceMappingURL=admin.js.map

module.exports={};