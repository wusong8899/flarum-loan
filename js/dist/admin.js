(function(r,h,c,i,p,n,t,l){"use strict";const u={isValidUrl(e){try{const a=new URL(e);return a.protocol==="http:"||a.protocol==="https:"}catch{return!1}},isImageUrl(e){if(!this.isValidUrl(e))return!1;const a=["jpg","jpeg","png","gif","svg","webp"],o=new URL(e).pathname.toLowerCase().split(".").pop()||"";return a.includes(o)},checkImageAccessible(e){return new Promise(a=>{const s=new Image;s.onload=()=>a(!0),s.onerror=()=>a(!1),s.src=e})}};class d extends p{oninit(a){super.oninit(a);const s=this.attrs.platform;this.name=n(s?s.name():""),this.logoUrl=n(s?s.logoUrl():""),this.linkUrl=n(s?s.sponsorLinkUrl():""),this.previewError=n(!1)}className(){return"PlatformEditModal Modal--small"}title(){return this.attrs.platform?"编辑平台":"新增平台"}content(){return t("div",{className:"Modal-body"},t("div",{className:"Form-group"},t("label",null,"平台名称"),t("input",{className:"FormControl",value:this.name(),oninput:a=>this.name(a.target.value),placeholder:"例如：支付宝"})),t("div",{className:"Form-group"},t("label",null,"Logo图片链接"),t("input",{className:"FormControl",type:"url",value:this.logoUrl(),oninput:a=>this.handleUrlChange(a.target.value),placeholder:"https://example.com/logo.png"}),t("div",{className:"helpText"},"请输入图片的完整URL地址（支持jpg、png、gif、svg格式）")),t("div",{className:"Form-group"},t("label",null,"赞助平台链接（可选）"),t("input",{className:"FormControl",type:"url",value:this.linkUrl(),oninput:a=>this.linkUrl(a.target.value),placeholder:"https://example.com/guide"})),this.logoUrl()&&t("div",{className:"Form-group"},t("label",null,"图片预览"),t("div",{className:"logo-preview"},this.previewError()?t("div",{className:"preview-error"},t("i",{className:"fas fa-exclamation-triangle"}),t("p",null,"图片加载失败，请检查链接是否正确")):t("img",{src:this.logoUrl(),alt:"Logo预览",onload:()=>{this.previewError(!1),t.redraw()},onerror:()=>{this.previewError(!0),t.redraw()}}))),t("div",{className:"Form-group"},t(i,{className:"Button Button--primary",loading:this.loading,disabled:!this.name()||!this.logoUrl()||this.previewError(),onclick:this.save.bind(this)},"保存")))}handleUrlChange(a){this.logoUrl(a),this.previewError(!1),a&&!this.isValidUrl(a)&&this.previewError(!0)}isValidUrl(a){return u.isValidUrl(a)&&u.isImageUrl(a)}async save(){if(!this.isValidUrl(this.logoUrl())){r.alerts.show({type:"error"},"请输入有效的图片链接");return}this.loading=!0;try{await(this.attrs.platform||r.store.createRecord("loan-platforms")).save({name:this.name(),logoUrl:this.logoUrl(),sponsorLinkUrl:this.linkUrl()}),this.attrs.onSave(),this.hide(),r.alerts.show({type:"success"},"保存成功")}finally{this.loading=!1}}}class g extends c{constructor(){super(...arguments),this.loading=!1,this.platforms=[]}oninit(a){super.oninit(a),this.loading=!0,this.platforms=[],this.loadPlatforms()}async loadPlatforms(){try{this.platforms=await r.store.find("loan-platforms")}finally{this.loading=!1,t.redraw()}}view(){return t("div",{className:"PlatformManager"},t("div",{className:"PlatformManager-header"},t("h3",null,"贷款平台管理"),t(i,{className:"Button Button--primary",onclick:()=>this.editPlatform()},"新增平台")),this.loading?t("div",null,"加载中..."):t("table",{className:"PlatformTable"},t("thead",null,t("tr",null,t("th",null,"Logo"),t("th",null,"平台名称"),t("th",null,"操作"))),t("tbody",null,this.platforms.map(a=>t("tr",{key:a.id()},t("td",null,t("img",{src:a.logoUrl(),style:"max-width: 50px;"})),t("td",null,a.name()),t("td",null,t(i,{className:"Button Button--link",onclick:()=>this.editPlatform(a)},"编辑"),t(i,{className:"Button Button--link",onclick:()=>this.deletePlatform(a)},"删除"),t(i,{className:"Button Button--link",onclick:()=>this.generateVirtual(a)},"生成虚拟数据")))))))}editPlatform(a=null){r.modal.show(d,{platform:a,onSave:()=>this.loadPlatforms()})}async deletePlatform(a){confirm("确定删除该平台吗？")&&(await a.delete(),this.loadPlatforms())}async generateVirtual(a){const s=prompt("请输入要生成的虚拟数据数量","10");s&&(await r.request({method:"POST",url:r.forum.attribute("apiUrl")+"/loan-applications/generate-virtual",body:{data:{attributes:{platform_id:a.id(),count:parseInt(s)}}}}),r.alerts.show({type:"success"},`成功生成${s}条虚拟数据`))}}class f extends c{constructor(){super(...arguments),this.loading=!1,this.applications=[]}oninit(a){super.oninit(a),this.loading=!0,this.applications=[],this.load()}async load(){try{this.applications=await r.store.find("loan-applications")}finally{this.loading=!1,t.redraw()}}view(){return t("div",{className:"ApplicationsManager"},t("div",{className:"ApplicationsManager-header"},t("h3",null,"贷款申请管理"),t(i,{className:"Button",onclick:()=>this.load()},"刷新")),this.loading?t("div",null,"加载中..."):t("table",{className:"ApplicationTable"},t("thead",null,t("tr",null,t("th",null,"用户"),t("th",null,"平台"),t("th",null,"赞助账号"),t("th",null,"申请账号"),t("th",null,"留言"),t("th",null,"状态"),t("th",null,"批准额度"),t("th",null,"操作"))),t("tbody",null,this.applications.map(a=>t("tr",{key:a.id()},t("td",null,a.user()&&a.user().displayName?a.user().displayName():"-"),t("td",null,a.platform()&&a.platform().name?a.platform().name():"-"),t("td",null,a.sponsorAccount?.()||"-"),t("td",null,a.applicantAccount?.()||"-"),t("td",null,a.message()),t("td",null,a.status()),t("td",null,a.approvedAmount()||"-"),t("td",null,t(i,{className:"Button Button--link",onclick:()=>this.review(a,"approved")},"通过"),t(i,{className:"Button Button--link",onclick:()=>this.review(a,"rejected")},"拒绝"),t(i,{className:"Button Button--link",onclick:()=>this.openSponsorLink(a)},"赞助链接"),t(i,{className:"Button Button--link",onclick:()=>this.remove(a)},"删除")))))))}async review(a,s){await r.request({method:"PATCH",url:`${r.forum.attribute("apiUrl")}/loan-applications/${a.id()}`,body:{data:{attributes:{status:s}}}}),await this.load()}async remove(a){confirm("确定删除该申请吗？")&&(await a.delete(),await this.load())}openSponsorLink(a){const s=a.platform(),o=s&&s.sponsorLinkUrl?s.sponsorLinkUrl():null;o?window.open(o,"_blank"):r.alerts.show({type:"warning"},"该平台未配置赞助平台链接")}}class v extends h{constructor(){super(...arguments),this.activeTab="platforms"}oninit(a){super.oninit(a),this.activeTab="platforms"}content(){return t("div",{className:"LoanSettingsPage"},t("div",{className:"LoanSettingsPage-tabs"},t("button",{className:this.activeTab==="platforms"?"active":"",onclick:()=>{this.activeTab="platforms",t.redraw()}},"平台管理"),t("button",{className:this.activeTab==="applications"?"active":"",onclick:()=>{this.activeTab="applications",t.redraw()}},"申请管理")),t("div",{className:"LoanSettingsPage-content"},this.activeTab==="platforms"&&t(g,null),this.activeTab==="applications"&&t(f,null)))}}class w extends l{constructor(){super(...arguments),this.name=l.attribute("name"),this.logoUrl=l.attribute("logoUrl"),this.sponsorLinkUrl=l.attribute("sponsorLinkUrl"),this.sortOrder=l.attribute("sortOrder")}}class b extends l{constructor(){super(...arguments),this.message=l.attribute("message"),this.sponsorAccount=l.attribute("sponsorAccount"),this.applicantAccount=l.attribute("applicantAccount"),this.status=l.attribute("status"),this.approvedAmount=l.attribute("approvedAmount"),this.createdAt=l.attribute("createdAt"),this.reviewedAt=l.attribute("reviewedAt"),this.user=l.hasOne("user"),this.platform=l.hasOne("platform")}}class U extends l{constructor(){super(...arguments),this.fakeUsername=l.attribute("fakeUsername"),this.fakeAvatarUrl=l.attribute("fakeAvatarUrl"),this.amount=l.attribute("amount"),this.platform=l.hasOne("platform")}}r.initializers.add("wusong8899-loan",()=>{r.extensionData.for("wusong8899-loan").registerPage(v),r.store.models["loan-platforms"]=w,r.store.models["loan-applications"]=b,r.store.models["loan-virtual-approvals"]=U})})(flarum.core.compat["admin/app"],flarum.core.compat["admin/components/ExtensionPage"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/utils/Stream"],m,flarum.core.compat["common/Model"]);
//# sourceMappingURL=admin.js.map

module.exports={};