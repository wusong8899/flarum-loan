(function(s,g,p,o,f,u,t,r){"use strict";const d={isValidUrl(n){try{const a=new URL(n);return a.protocol==="http:"||a.protocol==="https:"}catch{return!1}},isImageUrl(n){if(!this.isValidUrl(n))return!1;const a=["jpg","jpeg","png","gif","svg","webp"],l=new URL(n).pathname.toLowerCase().split(".").pop()||"";return a.includes(l)},checkImageAccessible(n){return new Promise(a=>{const e=new Image;e.onload=()=>a(!0),e.onerror=()=>a(!1),e.src=n})}};class v extends f{oninit(a){super.oninit(a);const e=this.attrs.platform;this.name=u(e?e.name():""),this.logoUrl=u(e?e.logoUrl():""),this.linkUrl=u(e?e.sponsorLinkUrl():""),this.currencyImageUrl=u(e?e.currencyImageUrl?.():""),this.previewError=u(!1)}className(){return"PlatformEditModal Modal--small"}title(){return this.attrs.platform?"编辑平台":"新增平台"}content(){return t("div",{className:"Modal-body"},t("div",{className:"Form-group"},t("label",null,"平台名称"),t("input",{className:"FormControl",value:this.name(),oninput:a=>this.name(a.target.value),placeholder:"例如：支付宝"})),t("div",{className:"Form-group"},t("label",null,"Logo图片链接"),t("input",{className:"FormControl",type:"url",value:this.logoUrl(),oninput:a=>this.handleUrlChange(a.target.value),placeholder:"https://example.com/logo.png"}),t("div",{className:"helpText"},"请输入图片的完整URL地址（支持jpg、png、gif、svg格式）")),t("div",{className:"Form-group"},t("label",null,"赞助平台链接（可选）"),t("input",{className:"FormControl",type:"url",value:this.linkUrl(),oninput:a=>this.linkUrl(a.target.value),placeholder:"https://example.com/guide"})),t("div",{className:"Form-group"},t("label",null,"货币图片链接（可选）"),t("input",{className:"FormControl",type:"url",value:this.currencyImageUrl(),oninput:a=>this.currencyImageUrl(a.target.value),placeholder:"https://example.com/currency.png"}),t("div",{className:"helpText"},"用于在前台显示批准额度前的货币图标")),this.logoUrl()&&t("div",{className:"Form-group"},t("label",null,"图片预览"),t("div",{className:"logo-preview"},this.previewError()?t("div",{className:"preview-error"},t("i",{className:"fas fa-exclamation-triangle"}),t("p",null,"图片加载失败，请检查链接是否正确")):t("img",{src:this.logoUrl(),alt:"Logo预览",onload:()=>{this.previewError(!1),t.redraw()},onerror:()=>{this.previewError(!0),t.redraw()}}))),t("div",{className:"Form-group"},t(o,{className:"Button Button--primary",loading:this.loading,disabled:!this.name()||!this.logoUrl()||this.previewError(),onclick:this.save.bind(this)},"保存")))}handleUrlChange(a){this.logoUrl(a),this.previewError(!1),a&&!this.isValidUrl(a)&&this.previewError(!0)}isValidUrl(a){return d.isValidUrl(a)&&d.isImageUrl(a)}async save(){if(!this.isValidUrl(this.logoUrl())){s.alerts.show({type:"error"},"请输入有效的图片链接");return}this.loading=!0;try{await(this.attrs.platform||s.store.createRecord("loan-platforms")).save({name:this.name(),logoUrl:this.logoUrl(),sponsorLinkUrl:this.linkUrl(),currencyImageUrl:this.currencyImageUrl()}),this.attrs.onSave(),this.hide(),s.alerts.show({type:"success"},"保存成功")}finally{this.loading=!1}}}class w extends p{constructor(){super(...arguments),this.loading=!1,this.platforms=[]}oninit(a){super.oninit(a),this.loading=!0,this.platforms=[],this.loadPlatforms()}async loadPlatforms(){try{this.platforms=await s.store.find("loan-platforms")}finally{this.loading=!1,t.redraw()}}view(){return t("div",{className:"PlatformManager"},t("div",{className:"PlatformManager-header"},t("h3",null,"贷款平台管理"),t(o,{className:"Button Button--primary",onclick:()=>this.editPlatform()},"新增平台")),this.loading?t("div",null,"加载中..."):t("table",{className:"PlatformTable"},t("thead",null,t("tr",null,t("th",null,"Logo"),t("th",null,"平台名称"),t("th",null,"操作"))),t("tbody",null,this.platforms.map(a=>t("tr",{key:a.id()},t("td",null,t("img",{src:a.logoUrl(),style:"max-width: 50px;"})),t("td",null,a.name()),t("td",null,t(o,{className:"Button Button--link",onclick:()=>this.editPlatform(a)},"编辑"),t(o,{className:"Button Button--link",onclick:()=>this.deletePlatform(a)},"删除"),a.sponsorLinkUrl?.()&&t(o,{className:"Button Button--link",onclick:()=>window.open(a.sponsorLinkUrl(),"_blank")},"打开赞助链接"),t(o,{className:"Button Button--link",onclick:()=>this.generateVirtual(a)},"生成虚拟数据")))))))}editPlatform(a=null){s.modal.show(v,{platform:a,onSave:()=>this.loadPlatforms()})}async deletePlatform(a){confirm("确定删除该平台吗？")&&(await a.delete(),this.loadPlatforms())}async generateVirtual(a){const e=prompt("请输入要生成的虚拟数据数量","10");e&&(await s.request({method:"POST",url:s.forum.attribute("apiUrl")+"/loan-applications/generate-virtual",body:{data:{attributes:{platform_id:a.id(),count:parseInt(e)}}}}),s.alerts.show({type:"success"},`成功生成${e}条虚拟数据`))}}class y extends p{constructor(){super(...arguments),this.loading=!1,this.applications=[]}oninit(a){super.oninit(a),this.loading=!0,this.applications=[],this.load()}async load(){try{this.applications=await s.store.find("loan-applications",{include:"user,platform"})}finally{this.loading=!1,t.redraw()}}view(){return t("div",{className:"ApplicationsManager"},t("div",{className:"ApplicationsManager-header"},t("h3",null,"贷款申请管理"),t(o,{className:"Button",onclick:()=>this.load()},"刷新")),this.loading?t("div",null,"加载中..."):t("table",{className:"ApplicationTable"},t("thead",null,t("tr",null,t("th",null,"用户"),t("th",null,"平台"),t("th",null,"赞助账号"),t("th",null,"还款日期"),t("th",null,"状态"),t("th",null,"批准额度"),t("th",null,"操作"))),t("tbody",null,this.applications.map(a=>t("tr",{key:a.id()},t("td",null,a.user()&&a.user().displayName?a.user().displayName():"-"),t("td",null,a.platform()&&a.platform().name?a.platform().name():"-"),t("td",null,a.sponsorAccount?.()||"-"),t("td",null,this.renderRepaymentCell(a.repaymentDate?.())),t("td",null,a.status()),t("td",null,a.approvedAmount()||"-"),t("td",null,t(o,{className:"Button Button--link",onclick:()=>this.review(a,"approved")},"通过"),t(o,{className:"Button Button--link",onclick:()=>this.review(a,"rejected")},"拒绝"),t(o,{className:"Button Button--link",onclick:()=>this.openSponsorLink(a)},"赞助链接"),t(o,{className:"Button Button--link",onclick:()=>this.remove(a)},"删除")))))))}renderRepaymentCell(a){const e=parseInt(s.forum.attribute("loanRepaymentMaxMonths")||"6",10),l=b(a,e);if(!a)return t("span",null,"-");if(l)return t("span",{className:"overdue"},"未还款");const i=new Date(a);if(isNaN(i.getTime()))return t("span",null,a);const h=i.getFullYear(),c=String(i.getMonth()+1).padStart(2,"0"),A=String(i.getDate()).padStart(2,"0"),x=`${h}-${c}-${A}`;return t("span",null,x)}async review(a,e){const l={status:e};if(e==="approved"){const i=a.approvedAmount?.()?String(a.approvedAmount()):"",h=prompt("请输入批准额度（整数）",i);if(h===null)return;const c=parseInt(h,10);if(isNaN(c)||c<0){alert("请输入有效的非负整数");return}l.approved_amount=c}else l.approved_amount=null;await s.request({method:"PATCH",url:`${s.forum.attribute("apiUrl")}/loan-applications/${a.id()}`,body:{data:{attributes:l}}}),await this.load()}async remove(a){confirm("确定删除该申请吗？")&&(await a.delete(),await this.load())}openSponsorLink(a){const e=a.platform(),l=e&&e.sponsorLinkUrl?e.sponsorLinkUrl():null;l?window.open(l,"_blank"):s.alerts.show({type:"warning"},"该平台未配置赞助平台链接")}}function b(n,a){if(!n)return!1;const e=new Date(n);if(isNaN(e.getTime()))return!1;const l=new Date;if(!a||a<=0)return l>e;const i=N(e,a);return l>i}function N(n,a){const e=new Date(n.getTime()),l=e.getDate();return e.setMonth(e.getMonth()+a),e.getDate()<l&&e.setDate(0),e}class U extends g{constructor(){super(...arguments),this.activeTab="platforms"}oninit(a){super.oninit(a),this.activeTab="platforms"}content(){return t("div",{className:"LoanSettingsPage"},t("div",{className:"LoanSettingsPage-basic"},t("h4",null,"基础设置"),t("form",{onsubmit:this.saveSettings.bind(this)},t("div",{className:"Form-group"},t("label",null,"订单 Logo 图片 URL"),t("input",{className:"FormControl",value:this.setting("wusong8899-loan.logo_url")(),oninput:a=>this.setting("wusong8899-loan.logo_url")(a.target.value),placeholder:"https://example.com/logo.png"})),t("div",{className:"Form-group"},t("label",null,"还款日期最大月数"),t("input",{className:"FormControl",type:"number",min:"1",value:this.setting("wusong8899-loan.repayment_max_months")(),oninput:a=>this.setting("wusong8899-loan.repayment_max_months")(a.target.value),placeholder:"例如：6"})),t("div",{className:"Form-group"},t("button",{type:"submit",className:"Button Button--primary"},"保存")))),t("div",{className:"LoanSettingsPage-tabs"},t("button",{className:this.activeTab==="platforms"?"active":"",onclick:()=>{this.activeTab="platforms",t.redraw()}},"平台管理"),t("button",{className:this.activeTab==="applications"?"active":"",onclick:()=>{this.activeTab="applications",t.redraw()}},"申请管理")),t("div",{className:"LoanSettingsPage-content"},this.activeTab==="platforms"&&t(w,null),this.activeTab==="applications"&&t(y,null),t("div",{className:"LoanSettingsPage-danger"},t("h4",null,"危险操作"),t("button",{className:"Button Button--danger",onclick:this.clearAll.bind(this)},"一键清空申请/审批"))))}async clearAll(){if(confirm("确定要清空所有申请与虚拟审批数据吗？此操作不可撤销。"))try{await s.request({method:"DELETE",url:s.forum.attribute("apiUrl")+"/loan-clear"}),s.alerts.show({type:"success"},"已清空申请与虚拟审批数据")}catch(a){s.alerts.show({type:"error"},"清空失败 "+a)}}}class k extends r{constructor(){super(...arguments),this.name=r.attribute("name"),this.logoUrl=r.attribute("logoUrl"),this.sponsorLinkUrl=r.attribute("sponsorLinkUrl"),this.currencyImageUrl=r.attribute("currencyImageUrl"),this.sortOrder=r.attribute("sortOrder")}}class L extends r{constructor(){super(...arguments),this.sponsorAccount=r.attribute("sponsorAccount"),this.repaymentDate=r.attribute("repaymentDate"),this.status=r.attribute("status"),this.approvedAmount=r.attribute("approvedAmount"),this.createdAt=r.attribute("createdAt"),this.reviewedAt=r.attribute("reviewedAt"),this.user=r.hasOne("user"),this.platform=r.hasOne("platform")}}class P extends r{constructor(){super(...arguments),this.fakeUsername=r.attribute("fakeUsername"),this.fakeAvatarUrl=r.attribute("fakeAvatarUrl"),this.amount=r.attribute("amount"),this.platform=r.hasOne("platform")}}s.initializers.add("wusong8899-loan",()=>{s.extensionData.for("wusong8899-loan").registerPage(U),s.store.models["loan-platforms"]=k,s.store.models["loan-applications"]=L,s.store.models["loan-virtual-approvals"]=P})})(flarum.core.compat["admin/app"],flarum.core.compat["admin/components/ExtensionPage"],flarum.core.compat["common/Component"],flarum.core.compat["common/components/Button"],flarum.core.compat["common/components/Modal"],flarum.core.compat["common/utils/Stream"],m,flarum.core.compat["common/Model"]);
//# sourceMappingURL=admin.js.map

module.exports={};